<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">

<!-- Mirrored from processors.wiki.ti.com/index.php/HIDEmuKbd_SensorTag by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 01 Dec 2020 08:20:09 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="UTF-8"/>
<title>HIDEmuKbd SensorTag - Texas Instruments Wiki</title>
<script>document.documentElement.className = document.documentElement.className.replace( /(^|\s)client-nojs(\s|$)/, "$1client-js$2" );</script>
<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"HIDEmuKbd_SensorTag","wgTitle":"HIDEmuKbd SensorTag","wgCurRevisionId":205370,"wgRevisionId":205370,"wgArticleId":39139,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Bluetooth / Bluetooth Low Energy","Template examples"],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"HIDEmuKbd_SensorTag","wgRelevantArticleId":39139,"wgRequestId":"cce59aeb3647cef2ebe26244","wgIsProbablyEditable":false,"wgRelevantPageIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[]});mw.loader.state({"site.styles":"ready","noscript":"ready","user.styles":"ready","user":"ready","user.options":"ready","user.tokens":"loading","mediawiki.legacy.shared":"ready","mediawiki.legacy.commonPrint":"ready","mediawiki.sectionAnchor":"ready","mediawiki.skinning.interface":"ready","skins.vector.styles":"ready"});mw.loader.implement("user.tokens@19o3a1s",function($,jQuery,require,module){/*@nomin*/mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});
});mw.loader.load(["site","mediawiki.page.startup","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.toc","mediawiki.searchSuggest","skins.vector.js"]);});</script>
<link rel="stylesheet" href="https://processors.wiki.ti.com/load.php?debug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint%2Cshared%7Cmediawiki.sectionAnchor%7Cmediawiki.skinning.interface%7Cskins.vector.styles&amp;only=styles&amp;skin=vector"/>
<script async="" src="https://processors.wiki.ti.com/load.php?debug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=vector"></script>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="https://processors.wiki.ti.com/load.php?debug=false&amp;lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=vector"/>
<meta name="generator" content="MediaWiki 1.31.6"/>
<link rel="shortcut icon" href="https://processors.wiki.ti.com/favicon.ico"/>
<link rel="search" type="application/opensearchdescription+xml" href="https://processors.wiki.ti.com/opensearch_desc.php" title="Texas Instruments Wiki (en)"/>
<link rel="EditURI" type="application/rsd+xml" href="https://processors.wiki.ti.com/api.php?action=rsd"/>
<link rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"/>
<link rel="alternate" type="application/atom+xml" title="Texas Instruments Wiki Atom feed" href="https://processors.wiki.ti.com/index.php?title=Special:RecentChanges&amp;feed=atom"/>
<!--[if lt IE 9]><script src="/load.php?debug=false&amp;lang=en&amp;modules=html5shiv&amp;only=scripts&amp;skin=Vector&amp;sync=1"></script><![endif]-->
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-HIDEmuKbd_SensorTag rootpage-HIDEmuKbd_SensorTag skin-vector action-view">		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<div id="content" class="mw-body" role="main">
			<a id="top"></a>
			<div id="siteNotice" class="mw-body-content"><div id="localNotice" lang="en" dir="ltr"><div class="mw-parser-output"><p><br />
<span style="color:#ff0000"><b>NOTICE: The Processors Wiki will End-of-Life on January 15, 2021. It is recommended to download any files or other content you may need that are hosted on processors.wiki.ti.com. The site is now set to read only.</b></span>
</p></div></div></div><div class="mw-indicators mw-body-content">
</div>
<h1 id="firstHeading" class="firstHeading" lang="en">HIDEmuKbd SensorTag</h1>			<div id="bodyContent" class="mw-body-content">
				<div id="siteSub" class="noprint">From Texas Instruments Wiki</div>				<div id="contentSub"></div>
								<div id="jump-to-nav" class="mw-jump">
					Jump to:					<a href="#mw-head">navigation</a>, 					<a href="#p-search">search</a>
				</div>
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div class="mw-parser-output"><div id="toc" class="toc"><div class="toctitle" lang="en" dir="ltr"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Introduction_.28THIS_PAGE_IS_UNDER_CONSTRUCTION.29"><span class="tocnumber">1</span> <span class="toctext">Introduction (THIS PAGE IS UNDER CONSTRUCTION)</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Prerequisites"><span class="tocnumber">2</span> <span class="toctext">Prerequisites</span></a>
<ul>
<li class="toclevel-2 tocsection-3"><a href="#Hardware"><span class="tocnumber">2.1</span> <span class="toctext">Hardware</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#Software"><span class="tocnumber">2.2</span> <span class="toctext">Software</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-5"><a href="#Getting_Started"><span class="tocnumber">3</span> <span class="toctext">Getting Started</span></a>
<ul>
<li class="toclevel-2 tocsection-6"><a href="#Setting_up_the_software_environment"><span class="tocnumber">3.1</span> <span class="toctext">Setting up the software environment</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#Application_and_project_overview"><span class="tocnumber">3.2</span> <span class="toctext">Application and project overview</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#Compile_.26_Download_to_Device"><span class="tocnumber">3.3</span> <span class="toctext">Compile &amp; Download to Device</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-9"><a href="#Tutorial_Step_0:_About_the_Custom_Application"><span class="tocnumber">4</span> <span class="toctext">Tutorial Step 0: About the Custom Application</span></a></li>
<li class="toclevel-1 tocsection-10"><a href="#Tutorial_Step_1:_Set_up_Files_and_Folder_Structure"><span class="tocnumber">5</span> <span class="toctext">Tutorial Step 1: Set up Files and Folder Structure</span></a>
<ul>
<li class="toclevel-2 tocsection-11"><a href="#Make_a_Copy_of_the_HIDEmuKbd_Project"><span class="tocnumber">5.1</span> <span class="toctext">Make a Copy of the HIDEmuKbd Project</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-12"><a href="#Tutorial_Step_2:_Port_the_SensorTagHID_Source_Code"><span class="tocnumber">6</span> <span class="toctext">Tutorial Step 2: Port the SensorTagHID Source Code</span></a>
<ul>
<li class="toclevel-2 tocsection-13"><a href="#Edit_board_key.h"><span class="tocnumber">6.1</span> <span class="toctext">Edit board_key.h</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="#Edit_board_key.c"><span class="tocnumber">6.2</span> <span class="toctext">Edit board_key.c</span></a></li>
<li class="toclevel-2 tocsection-15"><a href="#Edit_hidemukbd.c"><span class="tocnumber">6.3</span> <span class="toctext">Edit hidemukbd.c</span></a></li>
<li class="toclevel-2 tocsection-16"><a href="#Edit_Board.h"><span class="tocnumber">6.4</span> <span class="toctext">Edit Board.h</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-17"><a href="#Tutorial_Step_3:_Compile.2C_Load_the_Program_and_Test"><span class="tocnumber">7</span> <span class="toctext">Tutorial Step 3: Compile, Load the Program and Test</span></a></li>
<li class="toclevel-1 tocsection-18"><a href="#Tutorial_Step_4:_HID_Descriptor_Tool"><span class="tocnumber">8</span> <span class="toctext">Tutorial Step 4: HID Descriptor Tool</span></a>
<ul>
<li class="toclevel-2 tocsection-19"><a href="#About_the_HID_Descriptor"><span class="tocnumber">8.1</span> <span class="toctext">About the HID Descriptor</span></a></li>
<li class="toclevel-2 tocsection-20"><a href="#Writing_the_Descriptor"><span class="tocnumber">8.2</span> <span class="toctext">Writing the Descriptor</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-21"><a href="#Tutorial_Step_5:_Turn_the_SensorTag_into_Consumer_Device_Controller"><span class="tocnumber">9</span> <span class="toctext">Tutorial Step 5: Turn the SensorTag into Consumer Device Controller</span></a>
<ul>
<li class="toclevel-2 tocsection-22"><a href="#Edit_hidemukbd.c_2"><span class="tocnumber">9.1</span> <span class="toctext">Edit hidemukbd.c</span></a></li>
<li class="toclevel-2 tocsection-23"><a href="#Edit_hiddev.h"><span class="tocnumber">9.2</span> <span class="toctext">Edit hiddev.h</span></a></li>
<li class="toclevel-2 tocsection-24"><a href="#Edit_hidkbdservice.c"><span class="tocnumber">9.3</span> <span class="toctext">Edit hidkbdservice.c</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-25"><a href="#Tutorial_Step_6:_Add_Support_For_the_MPU-9250"><span class="tocnumber">10</span> <span class="toctext">Tutorial Step 6: Add Support For the MPU-9250</span></a>
<ul>
<li class="toclevel-2 tocsection-26"><a href="#Add_drivers"><span class="tocnumber">10.1</span> <span class="toctext">Add drivers</span></a></li>
<li class="toclevel-2 tocsection-27"><a href="#Add_hidconsumerdevice.h"><span class="tocnumber">10.2</span> <span class="toctext">Add hidconsumerdevice.h</span></a></li>
<li class="toclevel-2 tocsection-28"><a href="#Add_hidconsumerdevice.c"><span class="tocnumber">10.3</span> <span class="toctext">Add hidconsumerdevice.c</span></a></li>
<li class="toclevel-2 tocsection-29"><a href="#Edit_main.c"><span class="tocnumber">10.4</span> <span class="toctext">Edit main.c</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="#Edit_hidemukbd.h"><span class="tocnumber">10.5</span> <span class="toctext">Edit hidemukbd.h</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="#Edit_hidemukbd.c_3"><span class="tocnumber">10.6</span> <span class="toctext">Edit hidemukbd.c</span></a></li>
<li class="toclevel-2 tocsection-32"><a href="#Edit_sensor_mpu9250.c"><span class="tocnumber">10.7</span> <span class="toctext">Edit sensor_mpu9250.c</span></a></li>
<li class="toclevel-2 tocsection-33"><a href="#Edit_bsp_i2c.c"><span class="tocnumber">10.8</span> <span class="toctext">Edit bsp_i2c.c</span></a></li>
<li class="toclevel-2 tocsection-34"><a href="#Edit_Board.c"><span class="tocnumber">10.9</span> <span class="toctext">Edit Board.c</span></a></li>
<li class="toclevel-2 tocsection-35"><a href="#Edit_Board.h_2"><span class="tocnumber">10.10</span> <span class="toctext">Edit Board.h</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-36"><a href="#Tutorial_Step_7:_Connect_and_Test"><span class="tocnumber">11</span> <span class="toctext">Tutorial Step 7: Connect and Test</span></a></li>
</ul>
</div>

<h1><span id="Introduction_(THIS_PAGE_IS_UNDER_CONSTRUCTION)"></span><span class="mw-headline" id="Introduction_.28THIS_PAGE_IS_UNDER_CONSTRUCTION.29">Introduction (THIS PAGE IS UNDER CONSTRUCTION)</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=1" title="Edit section: Introduction (THIS PAGE IS UNDER CONSTRUCTION)">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<table width="1000px">
<tbody><tr><td>
<p>This is a step by step guide on how to modify and use the Bluetooth Low Energy HID emulated keyboard (HIDEmuKbd) application using the SDK BLE-Stack provided for the CC2650EM on the SmartRF06EB, to the SimpleLink Multi-Standard CC2650 SensorTag. It will also cover how to modify the HID report descriptor making the SensorTag serve as a consumer device controller. The tutorial will cover how to port the basic functionality to set up a connection between the CC2540 USB Dongle and the SensorTag. The project will make use of a button driver to extend the functionality from just button press, to also detect release and longpress. The tutorial will take about 2 hours and requires some familiarity with embedded programming. Knowledge about TI-RTOS and HID is preferable but not required. 
</p>
<div style="padding:5px; border: 4px solid Red"> 
<center><b>Compatible with BLE-STACK V2</b></center>
<center> ble_cc26xx_setupwin32_2_00_00_42893 installer (February, 2015)</center> 
</div>
</td></tr></tbody></table>
<p>NOTE:<br />
<i>Currently Guide refers to the use of IAR Embedded Workbench</i>.
</p><p><br />
</p><p><br />
</p>
<h1><span class="mw-headline" id="Prerequisites">Prerequisites</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=2" title="Edit section: Prerequisites">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<table width="1000px">
<tbody><tr><td>
<p>In this chapter the required hardware and software is listed in separate sub chapters. It can be useful to have a little knowledge on Bluetooth Low Energy, Embedded programming and TI-RTOS (Real Time Operating System). Please Consider looking at some of the documentation that comes with the BLE stack installer. 
</p><p>If you comply with the following criterion you are good to go!
</p>
<ol><li>Basic knowledge of Bluetooth Low Energy.</li>
<li>Basic C-programming knowledge.</li>
<li>Basic knowledge of IAR Embedded workbench for ARM.</li>
<li>About 2 Hours available to complete this tutorial.</li></ol>
</td></tr></tbody></table>
<p><br />
</p>
<h2><span class="mw-headline" id="Hardware">Hardware</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=3" title="Edit section: Hardware">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<p>The following hardware is required to complete this guide: 
</p>
<ol>
<li>SimpleLink Multi-Standard CC2650 SensorTag </li>
<li>CC2540 USB Dongle</li>
<li>Micro USB cable </li>
<li>Computer with at least two available USB ports</li>
<li>SimpleLink SensorTag Debugger DevPack, or the SmartRF06EB</li>
</ol>
<div class="thumb tnone"><div class="thumbinner" style="width:502px;"><a href="File_CC2650SensorTag.html" class="image"><img alt="" src="https://processors.wiki.ti.com/images/6/66/CC2650SensorTag.jpeg" width="500" height="271" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="File_CC2650SensorTag.html" class="internal" title="Enlarge"></a></div>SimpleLink Multi-Standard CC2650 SensorTag</div></div></div>
<p>The SensorTag have an on-board PCB antenna meaning that you do not need any external antenna attached. Connect the SensorTag to the Debugger through the on board connectors, and connect the debugger to the computer with a micro-USB. 
</p>
</td></tr></tbody></table>
<p><br />
</p>
<h2><span class="mw-headline" id="Software">Software</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=4" title="Edit section: Software">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<ol>
<li>IAR Embedded Workbench for ARM (version 7.40.2 or later)</li>
<li>Emupack, found in the IAR installation: &lt;iar_install&gt;\arm\drivers\ti-xdsthe </li>
<li>BLE SDK 2.0 Stack Installer (<a rel="nofollow" class="external free" href="http://www.ti.com/tool/ble-stack">http://www.ti.com/tool/ble-stack</a>)</li>
<li>Button driver (Link is coming)</li>
<li>Software for the CC2540 USB Dongle (Link is coming)</li>
<li>HID Descriptor Tool: <a rel="nofollow" class="external free" href="http://www.usb.org/developers/hidpage">http://www.usb.org/developers/hidpage</a> </li>
</ol>
</td></tr></tbody></table>
<p><br />
</p>
<h1><span class="mw-headline" id="Getting_Started">Getting Started</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=5" title="Edit section: Getting Started">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<p>This chapter will show you how to compile the BLE Stack- and Application, and how to safely flash the programs into the SensorTag. We will assume that you already have an install of the IAR Embedded Workbench IDE and that you are familiar with the environment.
</p><p><br />
</p>
<h2><span class="mw-headline" id="Setting_up_the_software_environment">Setting up the software environment</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=6" title="Edit section: Setting up the software environment">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>After you install the SDK BLE-Stack, the USB drivers should automatically be associated with the debugger and CC2650 device connected to your USB port through a micro USB cable.
</p><p><b>Known issues:</b>
</p>
<ul><li>none</li></ul>
<p><b>Known warnings:</b>
</p>
<ul><li>When you download the stack, you may get 2 pop-up warnings, which can safely be ignored.</li></ul>
<p><br />
</p>
<h2><span class="mw-headline" id="Application_and_project_overview">Application and project overview</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=7" title="Edit section: Application and project overview">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<div class="floatright"><a href="File_SelectProject.html" class="image" title="selectProject.png"><img alt="selectProject.png" src="https://processors.wiki.ti.com/images/e/e9/SelectProject.png" width="200" height="264" /></a></div>
<p>The HIDEmuKbd project can be found here: 
<b>Projects\ble\HIDEmuKbd\CC26xx\IAR\HIDEmuKbd.eww</b><br />
The HIDEmuKbd project should compile and run on the SensorTag, but due to the differences of the on-board peripherals, the SensorTag can currently not be used for anything when it runs the unmodified program. The HIDEmuKbd project is composed of two IAR Projects grouped into one workspace. These two projects are the <b>CC2650App</b> and the <b>CC2650Stack</b> and can be selected by right clicking at the project and select "Set Active" (You need to debug from workspace showing both <i>Application</i> and <i>Stack</i>. Load the SensorTag with both projects one at the time, using the TI XDS110 Emulator through the JTAG interface found under the Options tab for each project. 
</p>
</td></tr></tbody></table>
<p><br />
</p>
<h2><span id="Compile_&amp;_Download_to_Device"></span><span class="mw-headline" id="Compile_.26_Download_to_Device">Compile &amp; Download to Device</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=8" title="Edit section: Compile &amp; Download to Device">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<div class="floatright"><a href="File_DWarning.html" class="image" title="dWarning.png"><img alt="dWarning.png" src="https://processors.wiki.ti.com/images/e/eb/DWarning.png" width="400" height="181" /></a></div>
<div class="floatright"><a href="File_Warning3.html" class="image" title="Warning3.PNG"><img alt="Warning3.PNG" src="https://processors.wiki.ti.com/images/d/d9/Warning3.PNG" width="400" height="117" /></a></div>
<p>The steps to load the project onto a CC2650 are as follows:
</p>
<ol><li>Compile the <b>CC2650App</b> project. The first time you run the compiler or do a rebuild, it might take up to a few minutes, as it is building the TI-RTOS kernel which is used in the project.</li>
<li>Compile the <b>CC2650Stack</b> project.</li>
<li>Download the application project.</li>
<li>Download the stack project. During the download you may see two warnings,  which are safe to ignore (image on the right illustrates the first of the two warnings). If you can see a third pop-up where you are given the choice to get an alternative file (see image to the right), press skip.</li>
<li>Select the CC2650App project and choose “Project -&gt; Debug without Downloading” to begin debugging.</li></ol>
</td></tr></tbody></table>
<p><br />
</p>
<h1><span class="mw-headline" id="Tutorial_Step_0:_About_the_Custom_Application">Tutorial Step 0: About the Custom Application</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=9" title="Edit section: Tutorial Step 0: About the Custom Application">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<table width="1000px">
<tbody><tr><td>
<p>The new, custom application, adapted for the SensorTag will use the two on-board buttons to simulate left- and right keyboard arrow keys, to step back and forth on the computer screen. The code can easily be modified to simulate any button on the keyboard. 
</p><p><br />
The program will use the button driver for initialization of GPIO pins and timers corresponding to the SensorTag buttons.
</p>
</td></tr></tbody></table>
<p><br />
</p>
<h1><span class="mw-headline" id="Tutorial_Step_1:_Set_up_Files_and_Folder_Structure">Tutorial Step 1: Set up Files and Folder Structure</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=10" title="Edit section: Tutorial Step 1: Set up Files and Folder Structure">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<table width="1000px">
<tbody><tr><td>
<p>In this section you will set up the file structure, add/replace files and modify the project settings to create our HIDEmuKbd SensorTag application. If you want to keep the original HIDEmuKbd EM installation, make sure to make a copy of the project you intend to make changes to.
</p>
</td></tr></tbody></table>
<p>The following abbreviation will be used to shorten the path name:
</p>
<div style="padding:5px; border: 4px solid #6d6"> 
<p><br />$PROJECTS$     =  C:\ti\simplelink\ble_cc26xx_2_00_00_42893
</p>
</div>
<p><br />
</p>
<h2><span class="mw-headline" id="Make_a_Copy_of_the_HIDEmuKbd_Project">Make a Copy of the HIDEmuKbd Project</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=11" title="Edit section: Make a Copy of the HIDEmuKbd Project">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<p>In order not to overwrite the original HIDEmuKbd project we will make a copy to work from.
</p><p><br />
</p>
<div class="thumb tright"><div class="thumbinner" style="width:304px;"><a href="File_IARWorkspace.html" class="image"><img alt="" src="https://processors.wiki.ti.com/images/5/51/IARWorkspace.PNG" width="302" height="481" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="File_IARWorkspace.html" class="internal" title="Enlarge"></a></div>The IAR Workspace after following the instructions</div></div></div>
<ol><li>Create the SensorTagHID folder:
<ul><li>Copy the folder <b>$PROJECTS$\Projects\ble\HIDEmuKbd</b> and all its subfolders and rename the copied folder to <i>SensorTagHID</i>.</li></ul></li>
<li>Rename <i>hidemukbd.c</i> and <i>hidemukbd.h</i>:
<ul><li>These are found in your newly created folder <b>$Projects$\Projects\ble\SensorTagHID\CC26xx\Source\Application</b>).</li>
<li>Rename them to <i>SensorTagHID.c</i> and <i>SensorTagHID.h</i>.</li></ul></li>
<li>Change the IAR project name:
<ul><li>The project file can be found in <b>$Projects$\Projects\ble\SensorTagHID\CC26xx\IAR Projects\</b>.</li>
<li>Change the name from <i>HIDEmuKbd.eww</i> to <i>SensorTagHID.eww</i>.</li></ul></li>
<li>Rename <i>HIDEmuKbd.custom_argvars</i>:
<ul><li>Rename file to <i>SensorTagHID.custom_argvars</i>.</li></ul></li>
<li>Setup the IAR Workspace:
<ul><li>Open the IAR workspace (SensorTagHID.eww.):</li>
<li>Select the <i>CC2650App</i> project.</li>
<li>Remove the two files <i>HIDEmuKbd.c</i> and <i>HIDEmuKbd.h</i> from the Application workspace folder.</li>
<li>Add the two files <i>SensorTagHID.c</i> and <i>SensorTagHID.h</i> from <b>$PROJECTS$\Projects\ble\SensorTagHID\CC26xx\Source\Application</b> to your project Application folder.</li>
<li>(ADD Button.c AND Button.h HERE?)</li></ul></li>
<li>Change the include directories  in the IAR Application workspace:
<ul><li>Go into the project options either by right-clicking on the <i>CC2650App-FlashROM</i> project in the workspace and click on <i>Options</i>. You can quickly enter this by pressing the short-cut keys <b>ALT+F7</b>. Then enter the <i>C/C++ Compiler</i> category and then the <i>Preprocessor</i> tab. There you will find the <i>Additional include directories</i>. This is where the C-compiler search for example after function prototypes in header files and more. Change the path names with <i>HIDEmuKbd</i> to <i>SensorTagHID</i>.</li></ul></li></ol>
</td></tr></tbody></table>
<p><br />
The project is now set up and ready to be modified!
</p><p><br />
</p>
<h1><span class="mw-headline" id="Tutorial_Step_2:_Port_the_SensorTagHID_Source_Code">Tutorial Step 2: Port the SensorTagHID Source Code</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=12" title="Edit section: Tutorial Step 2: Port the SensorTagHID Source Code">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<table width="1000px">
<tbody><tr><td>
<p>In this step you will edit the following source code files according to the instructions given in this step:
</p>
<ol><li><a href="HIDEmuKbd_SensorTag.html#Edit_board_key.h" title="HIDEmuKbd SensorTag"> board_key.h</a></li>
<li><a href="HIDEmuKbd_SensorTag.html#Edit_board_key.c" title="HIDEmuKbd SensorTag"> board_key.c</a></li>
<li><a href="HIDEmuKbd_SensorTag.html#Edit_hidemukbd.c" title="HIDEmuKbd SensorTag"> hidemukbd.c</a></li>
<li><a href="HIDEmuKbd_SensorTag.html#Edit_Board.h" title="HIDEmuKbd SensorTag"> Board.h</a></li></ol>
<p>Each sub-chapter covers one file each and must be edited according to this guide to be able to compile the project successfully at the end. You should follow this chronologically step by step. The parts of code that will be changed will be displayed in "from &#8658; to" code boxes which has the following format as illustrated in the box below. On the left you will find the original code, and on the right the new code will be displayed. Background color highlighting is used to illustrate parts that is removed, altered or added to help you to quickly visualize the change.
</p>
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td width="40%" valign="top">
<p><b>Original Code</b>
</p>
<pre>original code line;

Unaltered code;
Unaltered code;
Unaltered code;

<span style="background:#FFE4E1">original code line that will be removed;</span>
</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td width="40%" valign="top">
<p><b>Altered/New Code</b>
</p>
<pre><span style="background:#CCFFCC">Altered code line;</span>

Unaltered code;
Unaltered code;
Unaltered code;
<span style="background:#CCFFCC">
Added code line;
Added code line;</span>
</pre>
</td></tr></tbody></table>
</td></tr></tbody></table>
<p><br />
</p>
<h2><span class="mw-headline" id="Edit_board_key.h">Edit board_key.h</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=13" title="Edit section: Edit board key.h">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<ol>
<li>Add support for the button driver:</li>
<p>In order to support the button driver we need to determine our keys. Since the SmartRF06EB have more keys than the SensorTag we can just remove the irrelevant ones.
</p><p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
#define KEY_SELECT            0x0001
#define KEY_UP                0x0002
#define KEY_DOWN              0x0004
#define KEY_LEFT              0x0008
#define KEY_RIGHT             0x0010
<i></i></span>
</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
#define KEY_LEFT              0x01
#define KEY_RIGHT             0x02
<i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p><br />
</p>
<li>Add support for key events:</li>
<p>In order to register different kind of key events, we need to add a parameter to the callback function. This parameter will be able to save state data about the keys that was not possible on the Evaluation Board.
</p><p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
typedef void (*keysPressedCB_t)(uint8 keysPressed);
<i></i></span>
</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
typedef void (*keysPressedCB_t)(uint8 keysPressed, uint8_t keyEvent);
<i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<p><br />
</p>
<h2><span class="mw-headline" id="Edit_board_key.c">Edit board_key.c</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=14" title="Edit section: Edit board key.c">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<ol>
<li>Include the button driver:</li>
<p>The button driver consists of a source- and a header file (Button.c and Button.h). These should already have been added in <a href="HIDEmuKbd_SensorTag.html#Tutorial_Step_1:_Set_up_Files_and_Folder_Structure" title="HIDEmuKbd SensorTag"> Tutorial Step 1</a>, and is here included in the board_key.c 
<font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: default; color:; text-align:left; line-height: 1.3em;"><i></i>
#include "util.h"
#include "board_key.h"
#include "Board.h"
<i></i></span>
</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre>#include "util.h"
#include "board_key.h"
#include "Board.h"<span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
#include "Button.h"
<i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p><br />
</p>
<li>Change the initialization of the callback function:</li>
<p>In the original code, intended for the CC2650EM, the button functionality could only register button press. With the button driver it can also register button release, hence we need to add a parameter to the callback function, notifying the application which key event was triggered.
</p><p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
static void Board_keyCallback(PIN_Handle hPin, PIN_Id pinId);
<i></i></span>
</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
static void Board_keyCallback(PIN_Id pinId, buttonEventMask_t events);
<i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p><br />
</p>
<li>Set up and initialize the buttons and LEDs:</li>
<p>In this step, we set up the buttons and LEDs. The LEDs have basic on- and off functionality, while the buttons also have a Button_params structure. In this structure, the selected pins and pin functionality, debounce- and longpress time as well as the callback function are set. In the last function, board_initkeys(), called from the SensorTagHID.c, the button driver is opened and the parameters set in the button structure are used to initialize the button pins. The LEDs are not used in this program, but are smart to initialize anyway for debugging purposes.
</p><p><br />
<font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
PIN_State  keyPins;
PIN_Handle hKeyPins;
PIN_Config keyPinsCfg[] =
{
   Board_KEY_SELECT   | PIN_GPIO_OUTPUT_DIS | PIN_INPUT_EN  |  PIN_PULLUP,
   Board_KEY_UP       | PIN_GPIO_OUTPUT_DIS | PIN_INPUT_EN  |  PIN_PULLUP,
   Board_KEY_DOWN     | PIN_GPIO_OUTPUT_DIS | PIN_INPUT_EN  |  PIN_PULLUP,
   Board_KEY_LEFT     | PIN_GPIO_OUTPUT_DIS | PIN_INPUT_EN  |  PIN_PULLUP,
   Board_KEY_RIGHT    | PIN_GPIO_OUTPUT_DIS | PIN_INPUT_EN  |  PIN_PULLUP,
   PIN_TERMINATE
};
void Board_initKeys(keysPressedCB_t appKeyCB)
{
  // Initialize KEY pins. Enable int after callback registered
  hKeyPins = PIN_open(&amp;keyPins, keyPinsCfg);
  PIN_registerIntCb(hKeyPins, Board_keyCallback);
  PIN_setConfig(hKeyPins, PIN_BM_IRQ, Board_KEY_SELECT  | PIN_IRQ_NEGEDGE);
  PIN_setConfig(hKeyPins, PIN_BM_IRQ, Board_KEY_UP      | PIN_IRQ_NEGEDGE);
  PIN_setConfig(hKeyPins, PIN_BM_IRQ, Board_KEY_DOWN    | PIN_IRQ_NEGEDGE);
  PIN_setConfig(hKeyPins, PIN_BM_IRQ, Board_KEY_LEFT    | PIN_IRQ_NEGEDGE);
  PIN_setConfig(hKeyPins, PIN_BM_IRQ, Board_KEY_RIGHT   | PIN_IRQ_NEGEDGE);
#ifdef POWER_SAVING
  //Enable wakeup
  PIN_setConfig(hKeyPins, PINCC26XX_BM_WAKEUP, Board_KEY_SELECT | PINCC26XX_WAKEUP_NEGEDGE);
  PIN_setConfig(hKeyPins, PINCC26XX_BM_WAKEUP, Board_KEY_UP | PINCC26XX_WAKEUP_NEGEDGE);
  PIN_setConfig(hKeyPins, PINCC26XX_BM_WAKEUP, Board_KEY_DOWN | PINCC26XX_WAKEUP_NEGEDGE);
  PIN_setConfig(hKeyPins, PINCC26XX_BM_WAKEUP, Board_KEY_LEFT | PINCC26XX_WAKEUP_NEGEDGE);
  PIN_setConfig(hKeyPins, PINCC26XX_BM_WAKEUP, Board_KEY_RIGHT | PINCC26XX_WAKEUP_NEGEDGE);
#endif
// Setup keycallback for keys
Util_constructClock(&amp;keyChangeClock, Board_keyChangeHandler, KEY_DEBOUNCE_TIMEOUT, 0, false, 0);
// Set the application callback
appKeyChangeHandler = appKeyCB;
}
<i></i></span>
</pre>
<p><br />
</p>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
// PIN configuration structure to set all LED pins as inputs with pull-up enabled
PIN_Handle hLedPin;
PIN_State  ledPin;
PIN_Config ledPinCfg[] =
{
  Board_LED1 | PIN_GPIO_OUTPUT_EN | PIN_GPIO_HIGH   | PIN_PUSHPULL | PIN_DRVSTR_MAX,
  Board_LED2 | PIN_GPIO_OUTPUT_EN | PIN_GPIO_HIGH   | PIN_PUSHPULL | PIN_DRVSTR_MAX,
  PIN_TERMINATE,
};
// PIN configuration structure to set all KEY pins as inputs with pull-up enabled
PIN_Config keyPinsCfg[] =
{
   Board_KEY_LEFT   | PIN_INPUT_EN  | PIN_PULLUP | PIN_HYSTERESIS | PIN_INV_INOUT,
   Board_KEY_RIGHT  | PIN_INPUT_EN  | PIN_PULLUP | PIN_HYSTERESIS | PIN_INV_INOUT,
    PIN_TERMINATE
};
Button_Struct sButton;
Button_Handle hButton;
Button_Config buttonConfig[] =
{
   { .pinId = Board_KEY_LEFT, .eventMask= BTN_EV_PRESSED | BTN_EV_RELEASED | BTN_EV_LONGPRESSED
   },
   { .pinId = Board_KEY_RIGHT, .eventMask = BTN_EV_PRESSED | BTN_EV_RELEASED | BTN_EV_LONGPRESSED
   },
   { .pinId = PIN_TERMINATE
   }
};
Button_Params buttonParams = {
  .pinConfig    = keyPinsCfg,           // PIN_Config array
  .buttonConfig = buttonConfig,         // Button_Config array
  .tDebounce    = 50,                   // 50ms debounce timeout
  .tLongpress   = 1500,                 // 1500ms long-press timeout
  .callbackFxn  = Board_keyCallback     // Event callback function
};
void Board_initKeys(keysPressedCB_t appKeyCB)
{
  hButton = Button_open(&amp;sButton, &amp;buttonParams);

  // Set the application callback
  appKeyChangeHandler = appKeyCB;
}
<i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p><br />
</p>
<li>Modify the Callback Function:</li>
<p>In this function we will assign the button GPIO address pin to the corresponding variable. The function will return the right address and event to the HidEmuKbd_keyPressHandler, located in hidemukbd.c 
</p><p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>

static void Board_keyCallback(PIN_Handle hPin, PIN_Id pinId)
{
  keysPressed = 0;
  if ( PIN_getInputValue(Board_KEY_SELECT) == 0 )
  {
    keysPressed |= KEY_SELECT;
  }
  if ( PIN_getInputValue(Board_KEY_UP) == 0 )
  {
    keysPressed |= KEY_UP;
  }
  if ( PIN_getInputValue(Board_KEY_DOWN) == 0 )
  {
    keysPressed |= KEY_DOWN;
  }
  if ( PIN_getInputValue(Board_KEY_LEFT) == 0 )
  {
    keysPressed |= KEY_LEFT;
  }
  if ( PIN_getInputValue(Board_KEY_RIGHT) == 0 )
  {
    keysPressed |= KEY_RIGHT;
  }
  Util_startClock(&amp;keyChangeClock);
}                   
<i></i></span>
</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
static void Board_keyCallback(PIN_Id pinId, buttonEventMask_t events)
{
  uint8_t key;
  switch(pinId)
  {
    case Board_KEY_LEFT:
      key = KEY_LEFT;
      break;
    
    case Board_KEY_RIGHT:
      key = KEY_RIGHT;
      break;
    
    default:
      // do nothing
      break;
  }  
  (*appKeyChangeHandler)(key, events); //HidEmuKbd_keyPressHandler
}
<i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p><br />
</p>
<li>Delete the Board_keyChangeHandler function:</li>
<p>Since this is already being done last thing in Board_keyCallback (above), it have to be removed.
<font size="0.8">
</font></p><font size="0.8">
<pre style="background:#FFCCCC;"> static void Board_keyChangeHandler(UArg a0)
 {
   if (appKeyChangeHandler&#160;!= NULL)
   {
     // Notify the application
     (*appKeyChangeHandler)(keysPressed);
   }
 }
</pre>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<p><br />
</p>
<h2><span class="mw-headline" id="Edit_hidemukbd.c">Edit hidemukbd.c</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=15" title="Edit section: Edit hidemukbd.c">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>The hidemukbd.h does not need to change, so we jump directly to the hidemukbd.c.
</p>
<table width="1000px">
<tbody><tr><td>
<ol>
<li>Include the button driver, and add defines for a subset of HID consumer device controller usage IDs. These IDs will be explained in <a href="HIDEmuKbd_SensorTag.html#Tutorial_Step_4:_HID_Descriptor_Tool" title="HIDEmuKbd SensorTag"> Tutorial Step 4 </a>.</li>
<p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: default; color:; text-align:left; line-height: 1.3em;"><i></i>
#include "util.h"
#include "board_key.h"
#include "Board.h"
<i></i></span>
</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre>#include "util.h"
#include "board_key.h"
#include "Board.h"<span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
#include "Button.h"
<i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p><br />
</p>
<li>Add another variable to the HID event struct:</li>
<p>To be able to save data about button state, this struct needs to be enlarged. 
<font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
// App event passed from profiles.
typedef struct
{
  appEvtHdr_t hdr; // Event header
} hidEmuKbdEvt_t;
<i></i></span>
</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
typedef struct
{
  uint8_t event; // Which profile's event
  uint8_t key; 
  uint8_t state; // New state
} hidEmuKbdEvt_t;
<i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p><br />
</p>
<li>Update the function declarations with another parameter:</li>
<p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
static uint8_t HidEmuKbd_enqueueMsg(uint16_t event, uint8_t state);
static void HidEmuKbd_keyPressHandler(uint8_t keys);
static void HidEmuKbd_handleKeys(uint8_t shift, uint8_t keys);<i></i></span>

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
static uint8_t HidEmuKbd_enqueueMsg(uint16_t event, uint8_t state, uint8_t key);
static void HidEmuKbd_keyPressHandler(uint8_t key, uint8_t keyEvent);
static void HidEmuKbd_handleKeys(uint8_t shift, uint8_t key, uint8_t keyEvent);
<i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p><br />
</p>
<li>Modify the key handler: </li>
<p>This function assign the actual keyboard operation from what it gets as input, based on button and its event. If you study the differences in the functions, you can see that a function call (HidEmuKbd_sendReport(KEY_NONE);) is made in the end of each if statement in the left block. This function call notifies the application to release the button to be able to register a new button press. In the right block, instead there is a switch case with both button press- and release events. That means a button release report will not be sent unless you have actually released the button. This functionality opens up for longpress.
<font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
static void HidEmuKbd_handleKeys(uint8_t shift, uint8_t key, uint8_t keyEvent)
{
  (void)shift;  // Intentionally unreferenced parameter
  if (keys &amp; KEY_UP)
  {
    // Key Press.
    HidEmuKbd_sendReport(HID_KEYBOARD_UP_ARROW);
    // Key Release.
    // NB: releasing a key press will not propagate a signal to this function,
    // so a "key release" is reported immediately afterwards here.
    HidEmuKbd_sendReport(KEY_NONE);
  }
  if (keys &amp; KEY_DOWN)
  {
    // Key Press.
    HidEmuKbd_sendReport(HID_KEYBOARD_DOWN_ARROW);
    // Key Release.
    // NB: releasing a key press will not propagate a signal to this function,
    // so a "key release" is reported immediately afterwards here.
    HidEmuKbd_sendReport(KEY_NONE);
  }
  if (keys &amp; KEY_LEFT)
  {
    // Key Press.
    HidEmuKbd_sendReport(HID_KEYBOARD_LEFT_ARROW);
    // Key Release.
    // NB: releasing a key press will not propagate a signal to this function,
    // so a "key release" is reported immediately afterwards here.
    HidEmuKbd_sendReport(KEY_NONE);
  }
  if (keys &amp; KEY_RIGHT)
  {
    // Key Press.
    HidEmuKbd_sendReport(HID_KEYBOARD_RIGHT_ARROW);
    // Key Release
    // NB: releasing a key press will not propagate a signal to this function,
    // so a "key release" is reported immediately afterwards here.
    HidEmuKbd_sendReport(KEY_NONE);
  }
  if (keys &amp; KEY_SELECT)
  {
    if (hidBootMouseEnabled)
    {
      // Key Press.
      HidEmuKbd_sendMouseReport(MOUSE_BUTTON_1);
      // Key Release.
      // NB: releasing a key press will not propagate a signal to this function,
      // so a "key release" is reported immediately afterwards here.
      HidEmuKbd_sendMouseReport (MOUSE_BUTTON_NONE);
    }
  }
}
 <i></i></span>

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
static void HidEmuKbd_handleKeys(uint8_t shift, uint8_t key, uint8_t keyEvent)
{
  (void)shift;  // Intentionally unreferenced parameter
  if (key == KEY_RIGHT)
  {
    switch (keyEvent)
    {
      case BTN_EV_PRESSED:
        // Key Press.
        HidEmuKbd_sendReport(HID_KEYBOARD_RIGHT_ARROW);
        break;
      case BTN_EV_RELEASED:
        // Key Released.
        HidEmuKbd_sendReport(KEY_NONE);
        break;
      default:
        // do nothing
        break;
    }
  }
  if (key == KEY_LEFT)
  {
    switch (keyEvent)
    {
      case BTN_EV_PRESSED:
        // Key Press.
        HidEmuKbd_sendReport(HID_KEYBOARD_LEFT_ARROW);
        break;
      case BTN_EV_RELEASED:
        // Key Released.
        HidEmuKbd_sendReport(KEY_NONE);
        break;        
      default:
        // do nothing
        break;
    }
  }
}
<i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p><br />
</p>
<li>Modify the message queue:</li>
<p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
static uint8_t HidEmuKbd_enqueueMsg(uint16_t event, uint8_t state)
{
  hidEmuKbdEvt_t *pMsg; 
  // Create dynamic pointer to message.
  if (pMsg = ICall_malloc(sizeof(hidEmuKbdEvt_t)))
  {
    pMsg-&gt;hdr.event = event;
    pMsg-&gt;hdr.state = state;   
    // Enqueue the message.
    return Util_enqueueMsg(appMsgQueue, sem, (uint8_t *)pMsg);
  }  
  return FALSE;
} 
<i></i></span>
</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
uint8_t HidEmuKbd_enqueueMsg(uint16_t event, uint8_t key, uint8_t state)
{
  hidEmuKbdEvt_t *pMsg;
  if (pMsg = ICall_malloc(sizeof(hidEmuKbdEvt_t)))
  {
    pMsg-&gt;event = event;
    pMsg-&gt;state = state; 
    pMsg-&gt;key = key; 
    // Enqueue the message.
    return Util_enqueueMsg(appMsgQueue, sem, (uint8_t *)pMsg);
  }
  return FALSE;
}
 <i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p><br />
</p>
<li>Modify processAppMsg:</li>
<p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
static void HidEmuKbd_processAppMsg(hidEmuKbdEvt_t *pMsg)
{
  switch (pMsg-&gt;hdr.event)
  {
    case HIDEMUKBD_KEY_CHANGE_EVT:
      HidEmuKbd_handleKeys(0, pMsg-&gt;hdr.state);
      break;
    default:
      //Do nothing.
      break;
  }
}
<i></i></span>
</pre>
<p><br />
</p>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
static void HidEmuKbd_processAppMsg(hidEmuKbdEvt_t *pMsg)
{
  switch (pMsg-&gt;event)
  {
    case HIDEMUKBD_KEY_CHANGE_EVT:
      HidEmuKbd_handleKeys(0, pMsg-&gt;key, pMsg-&gt;state);
      break;       
    default:
      //Do nothing.
      break;
  }
}
 <i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
<li>Modify the key press handler:</li>
<p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
static void HidEmuKbd_keyPressHandler(uint8_t keys)
{
  // Enqueue the event.
  HidEmuKbd_enqueueMsg(HIDEMUKBD_KEY_CHANGE_EVT, keys);
} 
<i></i></span>
</pre>
<p><br />
</p>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
static void HidEmuKbd_keyPressHandler(uint8_t keys, uint8_t keyEvent)
{
  // Enqueue the event.
  HidEmuKbd_enqueueMsg(HIDEMUKBD_KEY_CHANGE_EVT, keys, keyEvent);
}
 <i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<p><br />
</p>
<h2><span class="mw-headline" id="Edit_Board.h">Edit Board.h</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=16" title="Edit section: Edit Board.h">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>The buttons has to be mapped to the right IO pins. This can be done in Board.h, which can be opened by first open "Board.c" under the "Startup" folder in the tree structure, and then right click on "Board.h" in that file, followed by "open Board.h".
</p>
<table width="1000px">
<tbody><tr><td>
<ol>


<font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
#define Board_KEY_LEFT              IOID_15
#define Board_KEY_RIGHT             IOID_18
<i></i></span>

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
#define Board_KEY_LEFT              IOID_0
#define Board_KEY_RIGHT             IOID_4
<i></i></span>

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<h1><span id="Tutorial_Step_3:_Compile,_Load_the_Program_and_Test"></span><span class="mw-headline" id="Tutorial_Step_3:_Compile.2C_Load_the_Program_and_Test">Tutorial Step 3: Compile, Load the Program and Test</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=17" title="Edit section: Tutorial Step 3: Compile, Load the Program and Test">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<table width="1000px">
<tbody><tr><td>
<p>If you have followed the steps accordingly to this guide, the SDK BLE-Stack should already be loaded on the SensorTag, hence we only need to load the new Application. At this point, you should be able to run the program and use the SensorTag buttons as keyboard right/left arrow keys to move the cursor back and forth on your computer monitor, by connecting the sensor tag to the CC2540 USB Dongle. If you want to use it as a consumer device controller, proceed to the next step of the tutorial.
</p>
</td></tr></tbody></table>
<p><br />
</p>
<h1><span class="mw-headline" id="Tutorial_Step_4:_HID_Descriptor_Tool">Tutorial Step 4: HID Descriptor Tool</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=18" title="Edit section: Tutorial Step 4: HID Descriptor Tool">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<table width="1000px">
<tbody><tr><td>
<p>To use the sensor tag as a consumer device, we need to tell the connected device so by changing the descriptor. This can easily be done using the HID Descriptor Tool found on the developer page on the USB website (<a rel="nofollow" class="external text" href="http://www.usb.org/developers/hidpage/">link</a>). The program does not need any installation. Just unzip the folder, double click the file "Dt.exe" and you are up and running.
</p>
<div class="thumb tnone"><div class="thumbinner" style="width:502px;"><a href="File_Descriptor.html" class="image"><img alt="" src="https://processors.wiki.ti.com/images/4/43/Descriptor.PNG" width="500" height="390" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="File_Descriptor.html" class="internal" title="Enlarge"></a></div>HID Descriptor Tool</div></div></div>
<p><br />
</p>
<h2><span class="mw-headline" id="About_the_HID_Descriptor">About the HID Descriptor</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=19" title="Edit section: About the HID Descriptor">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>HID, or Human Interface Device is a Bluetooth profile defined by the USB specification, used in devices where communication with a host over USB, Bluetooth or some other protocol is desirable. It can be used in a variety of devices, like keyboards, mice and game controllers. Most operating systems will recognize the HID device without the need for extra drivers, but it happens that the manufacturer has to write special drivers in order for the device to work correctly. The HID descriptor is used as a way to tell the host how to interpret data, and will look different for different devices.
</p><p><br />
</p>
<h2><span class="mw-headline" id="Writing_the_Descriptor">Writing the Descriptor</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=20" title="Edit section: Writing the Descriptor">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>Our device have two buttons, and in this tutorial we want to control the music as a Consumer Device, which means we can connect it to smart devices such as computers, phones and pads. Since we only have two buttons we can control basic functionality, in this tutorial; volume up/down, play and skip track. The picture above shows the HID Descriptor Tool with this functionality such as:
</p>
<ol>

<li>USAGE_PAGE: We want to start with telling the host what kind of device we indent to control. In our case it is a Consumer Device. </li>
<li>USAGE: We have to tell the host what kind of device it will expect messages from. In our case Consumer Control</li>
<li>COLLECTION: I don't even know. always? </li>
<li>REPORT_ID: Since we have only one device, it should have report ID 1.</li>
<li>USAGE: We want to have functionality for volume up, volume down pause and play. We usually need one USAGE per function, but instead of using play and pause in two different, there is (conveniently) a common command for that. Make sure to change the "Play" usage in the picture (09 B0) for "Play/Pause" command (09 CD).</li>
<li>LOGICAL_MINIMUM/MAXIMUM: Since we have four messages with different keycodes, we want to set the logical min/max to 1-4. When we select IDs from the usage ID list, without including the whole list, it is called making a subset of usage IDs. In our case, the first ID in the subset will have the logical value 1 and the last will have logical value 4 (or 0x01 to 0x04 in hexadecimal). This is why we defined the subset as we did in chapter <a href="HIDEmuKbd_SensorTag.html#Edit_hidemukbd.c" title="HIDEmuKbd SensorTag"> Edit hidemukbd.c</a>.</li>
<li>REPORT_COUNT: We chose to use one byte for each functionality, even though it would be enough to use just one bit each of a byte. report count is therefore set to 1 (01).</li>
<li>REPORT_SIZE: One byte has eight bits, why is we want to set this to 8 to use the whole byte for just one message.</li>
<li>INPUT: We decided earlier to use one whole byte for every usage instead for just a bit. In this step we therefor have to change from variable to array. leave the rest as default.</li>
<li>END_COLLECTION: This line states that the report is finished.</li>
</ol>
<p>From the programs interface, you can "save as" and chose as a .h-file. This will give you a nice structure with c syntax, ready to copy into your own code.
</p>
</td></tr></tbody></table>
<p><br />
</p>
<h1><span class="mw-headline" id="Tutorial_Step_5:_Turn_the_SensorTag_into_Consumer_Device_Controller">Tutorial Step 5: Turn the SensorTag into Consumer Device Controller</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=21" title="Edit section: Tutorial Step 5: Turn the SensorTag into Consumer Device Controller">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<table width="1000px">
<tbody><tr><td>
<p>In this step you will edit the following source code files according to the instructions given in this step:
</p>
<ol><li><a href="HIDEmuKbd_SensorTag.html#Edit_hidemukbd.c" title="HIDEmuKbd SensorTag"> hidemukbd.c</a></li>
<li><a href="HIDEmuKbd_SensorTag.html#Edit_hiddev.c" title="HIDEmuKbd SensorTag"> hiddev.c</a></li>
<li><a href="HIDEmuKbd_SensorTag.html#Edit_hidkbdservice.c" title="HIDEmuKbd SensorTag"> hidkbdservice.c</a></li></ol>
<p>Each sub-chapter covers one file each and must be edited according to the explanation in <a href="HIDEmuKbd_SensorTag.html#Tutorial_Step_2:_Port_Source_Code_to_Fit_SensorTag" title="HIDEmuKbd SensorTag"> Tutorial Step 2</a> to be able to compile the project successfully at the end. 
</p>
</td></tr></tbody></table>
<p><br />
</p>
<h2><span class="mw-headline" id="Edit_hidemukbd.c_2">Edit hidemukbd.c</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=22" title="Edit section: Edit hidemukbd.c">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>The default lenght is eight bytes, but we will only use two.
</p>
<table width="1000px">
<tbody><tr><td>
<ol>


<font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
#define HID_KEYBOARD_IN_RPT_LEN     8
<i></i></span>
</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
#define HID_KEYBOARD_IN_RPT_LEN     2
<i></i></span>
</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<p>Since the SensorTag only have two buttons, it is good to make use of the functionality "longpress" included in the button driver. Using longpress will give the application possibility to handle four different HID commands instead of just two. In the first function, HidEmuKbd_handleKeys, longpress is enabled and assigned as lower/higher volume on the right/left button, while a simple press pause/play music on the right button, and skip track on the left one. Since we do not use either a modifier key, or send more than one keycode at the time, the buffer should be shortened down. When we now want to control consumer devices, we need to set the first byte to a report ID number. We chose this number to 1, or 0x1 in hexadecimal.
</p>
<table width="1000px">
<tbody><tr><td>
<ol>


<font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
static void HidEmuKbd_handleKeys(uint8_t shift, uint8_t key, uint8_t keyEvent)
{
  (void)shift;  // Intentionally unreferenced parameter
  if (key == KEY_RIGHT)
  {
     switch (keyEvent)
     {
       case BTN_EV_PRESSED:
       // Key Press.
       HidEmuKbd_sendReport(HID_KEYBOARD_RIGHT_ARROW);
       break;
       
       case BTN_EV_RELEASED:
       // Key Released.
       HidEmuKbd_sendReport(KEY_NONE);
       break;
       
       default:
       // do nothing
       break;
     }
 }
 if (key == KEY_LEFT)
 {
   switch (keyEvent)
   {
       case BTN_EV_PRESSED:
       // Key Press.
       HidEmuKbd_sendReport(HID_KEYBOARD_LEFT_ARROW);
       break;
       
       case BTN_EV_RELEASED:
       // Key Released.
       HidEmuKbd_sendReport(KEY_NONE);
       break;
       
       default:
       // do nothing
       break;
     }
   }
}
static void HidEmuKbd_sendReport(uint8_t keycode)
{
    uint8_t buf[HID_KEYBOARD_IN_RPT_LEN];
    buf[0] = 0;         // Modifier keys
    buf[1] = 0;         // Reserved
    buf[2] = keycode;   // Keycode 1
    buf[3] = 0;         // Keycode 2
    buf[4] = 0;         // Keycode 3
    buf[5] = 0;         // Keycode 4
    buf[6] = 0;         // Keycode 5
    buf[7] = 0;         // Keycode 6
    HidDev_Report(HID_RPT_ID_KEY_IN, HID_REPORT_TYPE_INPUT,
                  HID_KEYBOARD_IN_RPT_LEN, buf);
}
<i></i></span>

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
static void HidEmuKbd_handleKeys(uint8_t shift, uint8_t key, uint8_t keyEvent)
{
  (void)shift;  // Intentionally unreferenced parameter
  if (key == KEY_RIGHT)
  {
     switch (keyEvent)
     {
       case BTN_EV_PRESSED:
       // Pause/Play
       HidEmuKbd_sendReport(HID_SUBSET_CONSUMER_PLAY_PAUSE);
       break;
       
       case BTN_EV_LONGPRESSED:
       // Volume Down
       HidEmuKbd_sendReport(HID_SUBSET_CONSUMER_VOLUME_DOWN);
       break;
       
       case BTN_EV_RELEASED:
       // Key Released.
       HidEmuKbd_sendReport(KEY_NONE);
       break;
       
       default:
       // do nothing
       break;
     }
   }
   if (key == KEY_LEFT)
   {
      switch (keyEvent)
      {
       case BTN_EV_PRESSED:
       // Next Track
       HidEmuKbd_sendReport(HID_SUBSET_CONSUMER_SKIP_TRACK);
       break;
       
       case BTN_EV_LONGPRESSED:
       // Volume Up
       HidEmuKbd_sendReport(HID_SUBSET_CONSUMER_VOLUME_UP);
       break;
       
       case BTN_EV_RELEASED:
       // Key Released.
       HidEmuKbd_sendReport(KEY_NONE);
       break;
       
       default:
       // do nothing
       break;
     }
   }
}
static void HidEmuKbd_sendReport(uint8_t keycode)
{
    uint8_t buf[HID_KEYBOARD_IN_RPT_LEN];
    buf[0] = 0x1;       // Report ID
    buf[1] = keycode;   // keycode
    HidDev_Report(HID_RPT_ID_KEY_IN, HID_REPORT_TYPE_INPUT,
                  HID_KEYBOARD_IN_RPT_LEN, buf);
}
<i></i></span>

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<p><br />
</p>
<h2><span class="mw-headline" id="Edit_hiddev.h">Edit hiddev.h</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=23" title="Edit section: Edit hiddev.h">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>We need to add the subset of HID commands to the hiddev.h file.
</p>
<table width="1000px">
<tbody><tr><td>
<ol>


<font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre> /*********************************************************************
 * CONSTANTS
 */                           

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre>/*********************************************************************
 * CONSTANTS
 */
<span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
// Consumer Device Controller reports
#define KEY_NONE                                0x00
#define HID_SUBSET_CONSUMER_PLAY_PAUSE          0x01
#define HID_SUBSET_CONSUMER_SKIP_TRACK          0x02
#define HID_SUBSET_CONSUMER_VOLUME_UP           0x03
#define HID_SUBSET_CONSUMER_VOLUME_DOWN         0x04
<i></i></span>

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<p><br />
</p><p><br />
</p>
<h2><span class="mw-headline" id="Edit_hidkbdservice.c">Edit hidkbdservice.c</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=24" title="Edit section: Edit hidkbdservice.c">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>The descriptor can be found in hidkbdservice.c. Remove the old one and replace it with the generated consumer device descriptor. Notice that we use the same report ID as chosen in the HidEmuKbd_sendReport function in <a href="HIDEmuKbd_SensorTag.html#Edit_hidemukbd.c" title="HIDEmuKbd SensorTag"> Edit hidemukbd.c </a>
</p>
<table width="1000px">
<tbody><tr><td>
<ol>

<font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
static CONST uint8 hidReportMap[] =
 {
  0x05, 0x01,     // Usage Pg (Generic Desktop)
  0x09, 0x06,     // Usage (Keyboard)
  0xA1, 0x01,     // Collection: (Application)
                  //
  0x05, 0x07,     // Usage Pg (Key Codes)
  0x19, 0xE0,     // Usage Min (224)
  0x29, 0xE7,     // Usage Max (231)
  0x15, 0x00,     // Log Min (0)
  0x25, 0x01,     // Log Max (1)
                  //
                  // Modifier byte
  0x75, 0x01,     // Report Size (1)
  0x95, 0x08,     // Report Count (8)
  0x81, 0x02,     // Input: (Data, Variable, Absolute)
                  //
                  // Reserved byte
  0x95, 0x01,     // Report Count (1)
  0x75, 0x08,     // Report Size (8)
  0x81, 0x01,     // Input: (Constant)
                  //
                  // LED report
  0x95, 0x05,     // Report Count (5)
  0x75, 0x01,     // Report Size (1)
  0x05, 0x08,     // Usage Pg (LEDs)
  0x19, 0x01,     // Usage Min (1)
  0x29, 0x05,     // Usage Max (5)
  0x91, 0x02,     // Output: (Data, Variable, Absolute)
                  //
                  // LED report padding
  0x95, 0x01,     // Report Count (1)
  0x75, 0x03,     // Report Size (3)
  0x91, 0x01,     // Output: (Constant)
                  //
                  // Key arrays (6 bytes)
  0x95, 0x06,     // Report Count (6)
  0x75, 0x08,     // Report Size (8)
  0x15, 0x00,     // Log Min (0)
  0x25, 0x65,     // Log Max (101)
  0x05, 0x07,     // Usage Pg (Key Codes)
  0x19, 0x00,     // Usage Min (0)
  0x29, 0x65,     // Usage Max (101)
  0x81, 0x00,     // Input: (Data, Array)
                 //
  0xC0            // End Collection
};
<i></i></span>

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
static CONST uint8 hidReportMap[] =
{
   0x05, 0x0c,                    // USAGE_PAGE (Consumer Devices)
   0x09, 0x01,                    // USAGE (Consumer Control)
   0xa1, 0x01,                    // COLLECTION (Application)
   0x85, 0x01,                    //   REPORT_ID (1)
   0x09, 0xCD,                    //   USAGE (Play/Pause)
   0x09, 0xB5,                    //   USAGE (Scan next track)
   0x09, 0xE9,                    //   USAGE (Volume up)
   0x09, 0xEA,                    //   USAGE (Volume down)
   0x15, 0x01,                    //   LOGICAL_MINIMUM (1)
   0x25, 0x04,                    //   LOGICAL_MAXIMUM (4)
   0x95, 0x01,                    //   REPORT_COUNT (1)
   0x75, 0x08,                    //   REPORT_SIZE (8)
   0x81, 0x00,                    //   INPUT (Data,Ary,Abs)
   0xc0                           // END_COLLECTION
};
<i></i></span>

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<p><br />
</p>
<h1><span class="mw-headline" id="Tutorial_Step_6:_Add_Support_For_the_MPU-9250">Tutorial Step 6: Add Support For the MPU-9250</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=25" title="Edit section: Tutorial Step 6: Add Support For the MPU-9250">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<table width="1000px">
<tbody><tr><td>
<p>The on-board inertial measurement unit (MPU-9250) adds interesting functionality in form of the possibility to orientate the SensorTag in space. The MPU-9250 is a 9-axis motiontracking device, which contains a 3-axis gyroscope, a 3-axis accelerometer and a 3-axis digital compass on the same silicon. For communication with the chip, I2C or SPI can be used, where we will use the I2C driver. The signals can be used one by one, or all together. This tutorial will use the acceleromter on its own and also together with the gyroscope. We will start and pause music on shake, and raise/lower the volume by tilting it left and right. For this, a new task will be created and used in the TI-RTOS. The following new files will be added and edited to the project:
</p>
<ol><li><a href="HIDEmuKbd_SensorTag.html#Add_hidconsumerdevice.h" title="HIDEmuKbd SensorTag"> hidconsumerdevice.h</a></li>
<li><a href="HIDEmuKbd_SensorTag.html#Add_hidconsumerdevice.c" title="HIDEmuKbd SensorTag"> hidconsumerdevice.c</a></li>
<li><a href="HIDEmuKbd_SensorTag.html#Edit_sensor_mpu9250.h" title="HIDEmuKbd SensorTag"> sensor_mpu9250.h</a></li>
<li><a href="HIDEmuKbd_SensorTag.html#Edit_sensor_mpu9250.c" title="HIDEmuKbd SensorTag"> sensor_mpu9250.c</a></li>
<li><a href="HIDEmuKbd_SensorTag.html#Add_drivers" title="HIDEmuKbd SensorTag"> bsp_i2c.h</a></li>
<li><a href="HIDEmuKbd_SensorTag.html#Add_drivers" title="HIDEmuKbd SensorTag"> bsp_i2c.c</a></li></ol>
<p>The following files will be edited according two the steps in the tutorial:
</p>
<ol><li><a href="HIDEmuKbd_SensorTag.html#Edit_hidemukbd.h" title="HIDEmuKbd SensorTag"> hidemukbd.h</a></li>
<li><a href="HIDEmuKbd_SensorTag.html#Edit_hidemukbd.c" title="HIDEmuKbd SensorTag"> hidemukbd.c</a></li>
<li><a href="HIDEmuKbd_SensorTag.html#Edit_main.c" title="HIDEmuKbd SensorTag"> main.c</a></li></ol>
<p>Each sub-chapter covers one file each and must be edited according to the explanation in <a href="HIDEmuKbd_SensorTag.html#Tutorial_Step_2:_Port_Source_Code_to_Fit_SensorTag" title="HIDEmuKbd SensorTag"> Tutorial Step 2</a> to be able to compile the project successfully at the end. 
</p>
</td></tr></tbody></table>
<h2><span class="mw-headline" id="Add_drivers">Add drivers</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=26" title="Edit section: Add drivers">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>The drivers for the MPU-9250 and the I2C are the same drivers used by several projects located in the "Projects" folder in the installation of the stack. Navigate to <b>$Projects$\Components\ti-rtos\boards\sensortag\Devices</b> and copy sensor_mpu9250.c and sensor_mpu9250.h into your projects folder located in <b>$Projects$\Projects\ble\SensorTagHID\CC26xx\Source\Application</b>. Then go to <b>$Projects$\Components\ti-rtos\boards\sensortag\Interfaces</b> and copy bsp_i2c.c and bsp_i2c.h also into the project folder. This is done because some changes are gonna be made to the files. Add the files to the project by right clicking "CC2650App - FlashROM" in the tree view in IAR and then chose "Add" &gt; "Add files". Navigate to <b>$Projects$\Projects\ble\SensorTagHID\CC26xx\Source\Application</b> and chose sensor_mpu9250.c, sensor_mpu9250.h, bsp_i2c.c and bsp_i2c.h.
</p>
<div class="thumb tnone"><div class="thumbinner" style="width:502px;"><a href="File_Add_files_in_tree.html" class="image"><img alt="" src="https://processors.wiki.ti.com/images/8/88/Add_files_in_tree.PNG" width="500" height="405" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="File_Add_files_in_tree.html" class="internal" title="Enlarge"></a></div>Add files</div></div></div>
<p>In order for the bsp_i2c driver to work, a core library is needed. This requires the TI RTOS drivers base number. This can be found under "Tools" &gt; "Configure Custom Argument Variables". Extend the CC26xx TI-RTOS folder and remember the numbers marked with "X" on the line "TI_RTOS_DRIVERS_BASE = C:\ti\tirtos_simplelink_2_XX_XX_XX\packages.
</p>
<div class="thumb tnone"><div class="thumbinner" style="width:502px;"><a href="File_TI_RTOS_DRIVERS_BASE.html" class="image"><img alt="" src="https://processors.wiki.ti.com/images/b/bc/TI_RTOS_DRIVERS_BASE.PNG" width="500" height="257" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="File_TI_RTOS_DRIVERS_BASE.html" class="internal" title="Enlarge"></a></div>Define I2C</div></div></div>
<p>Right click on the Drivers folder in the tree structure, and chose "Add" &gt; "Add Files" and navigate to "C:\ti\tirtos_simplelink_2_XX_XX_XX\packages\ti\drivers" and add "I2C.c" and "I2C.h". Do the same steps again but navigate to "C:\ti\tirtos_simplelink_2_XX_XX_XX\packages\ti\drivers\i2c" and add "I2CCC26CC.c" and "I2CCC26CC.h".
</p><p>Since we are gonna use the I2C driver integrated in TI-RTOS, we need to define it. To do this, right click on the at the top of the tree structure on the box "CC2640App - FlashROM*". Click "Options" &gt; "C/C++ Compiler" &gt; "Preprocessor" and define the driver on a new line at the bottom of the box "Defined symbols: (one per line)" by writing "TI_DRIVERS_I2C_INCLUDED", and press "OK".
</p>
<div class="thumb tnone"><div class="thumbinner" style="width:502px;"><a href="File_TI_DRIVERS_I2C_INCLUDED.html" class="image"><img alt="" src="https://processors.wiki.ti.com/images/5/52/TI_DRIVERS_I2C_INCLUDED.PNG" width="500" height="394" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="File_TI_DRIVERS_I2C_INCLUDED.html" class="internal" title="Enlarge"></a></div>TI-RTOS Drivers Base</div></div></div>
<p><br />
</p><p><br />
</p>
<h2><span class="mw-headline" id="Add_hidconsumerdevice.h">Add hidconsumerdevice.h</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=27" title="Edit section: Add hidconsumerdevice.h">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>Create a new file by clicking "File" &gt; "New" &gt; "File" or by pressing "CTRL + N" in your IAR workspace. Save the file to your project folder and name it hidconsumerdevice.h. Copy and paste the following code into the empty file and save.
</p>
<table width="1000px">
<tbody><tr><td>
<ol>


<font size="0.8">
<pre style="background:#CCFFCC;">#ifndef HID_COMSUMER_DEVICE_H
#define HID_COMSUMER_DEVICE_H

#ifdef __cplusplus
extern "C"
{
#endif

/* -----------------------------------------------------------------------------
*                                          Constants
* ------------------------------------------------------------------------------
*/
#define MOVEMENT_DATA_LEN              18

/*
 * Task creation function for the led blinking.
 */
extern void HidConsumerDevice_createTask(void);

#ifdef __cplusplus
}
#endif

#endif

</pre>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<h2><span class="mw-headline" id="Add_hidconsumerdevice.c">Add hidconsumerdevice.c</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=28" title="Edit section: Add hidconsumerdevice.c">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>In this file we will create a new task which will call MPU-9250 specific functions to gather data, and process it into useful information.
The accelerometer is sensitive to vibrations and is imprecise over short time, why the data has to be low pass filtered to smooth out the signal. This signal will output an acceleration and is used to sense shake. The gyroscope on the other hand is precise over short time but drifts, which is why the data has to be high pass filtered. The gyroscope will be used together with the accelerometer using sensor fusion with a complementary filter. This filter also takes care of the low- and high pass filtering of both signals and outputs a precise roll- or pitch angle, used to raise or lower the volume.
</p><p>Create a new file by clicking "File" &gt; "New" &gt; "File" or by pressing "CTRL + N" in your IAR workspace. Save the file to your project folder and name it hidconsumerdevice.c. Copy and paste the following code into the empty file and save. Add the files to the project by right clicking "CC2650App - FlashROM" in the tree view in IAR and then chose "Add" &gt; "Add files". Navigate to <b>$Projects$\Projects\ble\SensorTagHID\CC26xx\Source\Application</b> and chose hidconsumerdevice.c and hidconsumerdevice.h.
</p>
<table width="1000px">
<tbody><tr><td>
<ol>
 

<font size="0.8">
<pre style="background:#CCFFCC;">/* -----------------------------------------------------------------------------
*                                          Includes
* ------------------------------------------------------------------------------
*/
#include &lt;xdc/std.h&gt;
#include &lt;xdc/runtime/Error.h&gt;
#include &lt;xdc/runtime/System.h&gt;
#include &lt;ti/sysbios/BIOS.h&gt;
#include &lt;ti/sysbios/knl/Task.h&gt;
#include &lt;ti/sysbios/knl/Clock.h&gt;
#include &lt;ti/sysbios/knl/Semaphore.h&gt;
#include &lt;ti/sysbios/knl/Queue.h&gt;
#include &lt;ICall.h&gt;
#include "gatt.h"
#include "hci.h"
#include "gapgattserver.h"
#include "gattservapp.h"
#include "gatt_profile_uuid.h"
#include "devinfoservice.h"
#include "battservice.h"
#include "hidkbdservice.h"
#include "hiddev.h"
#include "peripheral.h"
#include "gapbondmgr.h"
#include "osal_snv.h"
#include "ICallBleAPIMSG.h"
#include "util.h"
#include "board_key.h"
#include "Board.h"
#include "Button.h"
#include "hidconsumerdevice.h"
#include "bsp_i2c.h"
#include "sensor_mpu9250.h"
#include "hidemukbd.h"
#include &lt;ti/drivers/UART.h&gt;
#include &lt;ti/drivers/uart/UARTCC26XX.h&gt;
#include &lt;math.h&gt;

/* -----------------------------------------------------------------------------
*                                           Constants
* ------------------------------------------------------------------------------
*/
//#define DEBUG_UART
// Battery level is critical when it is less than this&#160;%
#define DEFAULT_BATT_CRITICAL_LEVEL     6
// Task configuration
#define BLINK_TASK_PRIORITY             1
#ifndef BLINK_TASK_STACK_SIZE
#define BLINK_TASK_STACK_SIZE           644
#endif
// Task Events
#define BLINK_KEY_CHANGE_EVT            0x0001
// Length of the data for this sensor
#define SENSOR_DATA_LEN                 MOVEMENT_DATA_LEN
// Accelerometer specifics
#define ACC_ANGLE                       20
#define ACC_X_OFFSET                    0
#define ACC_Y_OFFSET                    0

#define HIDEMUKBD_IMU_CHANGE_EVT        0x0002
#define SAMPLE_TIME_MS                  10
#define M_PI                            3.14159265358979323846  /* pi */

/* -----------------------------------------------------------------------------
*                           Local Variables
* ------------------------------------------------------------------------------
*/
static uint8_t sensorData[SENSOR_DATA_LEN];

typedef struct
{
    float x;
    float y;
    float z;
} HidConsumerDevice_ImuData_t;

typedef enum {LEFT, RIGHT, FLAT, NONE} direction_t;
direction_t dirX = NONE;
direction_t dirY = NONE;

typedef enum {ZERO, ONE, TWO, THREE} shakes_t;
shakes_t axisY = ZERO;

typedef int skipLoops_t;
skipLoops_t scaleDownAngleTime = 0;
skipLoops_t scaleDownShakeTime = 0;

PIN_Handle pinHandle;
// UART
UART_Handle handle;
UART_Params params;
// Task configuration
Task_Struct HidConsumerDevice_Task;
Char HidConsumerDevice_TaskStack[BLINK_TASK_STACK_SIZE];
// MPU9250
HidConsumerDevice_ImuData_t gyr;
HidConsumerDevice_ImuData_t acc;

/* -----------------------------------------------------------------------------
*                           Local Functions
* ------------------------------------------------------------------------------
*/
void HidConsumerDevice_createTask(void);
static void Mpu9250_taskFxn(UArg a0, UArg a1);
static bool HidConsumerDevice_AxisFlat(float axis);
static void HidConsumerDevice_ProcessVolumeEvent(float angX, float angY);
static void HidConsumerDevice_ComplementaryFilter(HidConsumerDevice_ImuData_t gyr, HidConsumerDevice_ImuData_t acc, float *angX, float *angY);
static bool HidConsumerDevice_ScaleDownTime(skipLoops_t time, float sec);
static void HidConsumerDevice_ProcessVolumeEvent(float angX, float angY);
static void HidConsumerDevice_ConvertSensorData();
static float HidConsumerDevice_LowPassFilter(float input);
static void HidConsumerDevice_ProcessShake(float ang);
static void led_on(int16_t led);
static void led_off(int16_t led);
static void UART_init_non_default();

/* -----------------------------------------------------------------------------
*                       
* ------------------------------------------------------------------------------
*/
void HidConsumerDevice_createTask(void)
{
    Task_Params taskParams
    Task_Params_init(&amp;taskParams);
    taskParams.stack = HidConsumerDevice_TaskStack;
    taskParams.stackSize = BLINK_TASK_STACK_SIZE;
    taskParams.priority = BLINK_TASK_PRIORITY;
    Task_construct(&amp;HidConsumerDevice_Task, Mpu9250_taskFxn, &amp;taskParams, NULL);
}

void led_on(int16_t led)
{
    PIN_setOutputValue(pinHandle, led, 1);
}

void led_off(int16_t led)
{
    PIN_setOutputValue(pinHandle, led, 0);
}

void UART_init_non_default()
{
    // Init UART and specify non-default parameters
    UART_Params_init(&amp;params);
    params.baudRate      = 9600;
    params.writeDataMode = UART_DATA_BINARY;
    // Open the UART and do the write
    handle = UART_open(Board_UART, &amp;params);
}

void HidConsumerDevice_ComplementaryFilter(HidConsumerDevice_ImuData_t gyr, HidConsumerDevice_ImuData_t acc, float *angX, float *angY)
{
    float accRoll  = atan(acc.y / sqrt(acc.x * acc.x + acc.z * acc.z)) * 180 / M_PI;
    float accPitch = atan2(- acc.x, acc.z) * 180 / M_PI;
    *angX = (0.91 * (*angX + gyr.x * SAMPLE_TIME_MS /1000) + 0.09 * accRoll); // Calculate the angle using a Complimentary filter
    *angY = (0.91 * (*angY + gyr.y * SAMPLE_TIME_MS /1000) + 0.09 * accPitch);
}

bool HidConsumerDevice_AxisFlat(float axis)
{
    if((abs((int)axis) &lt; (12))){
        return true;
    }
    else{
        return false;
    }
}

bool HidConsumerDevice_ScaleDownTime(skipLoops_t time, float sec)
{
    if(time &gt; sec * (1000 / SAMPLE_TIME_MS)){
        return true;
    }
    else{
        return false;
    }
}

void HidConsumerDevice_ProcessVolumeEvent(float angX, float angY)
{
    if((HidConsumerDevice_AxisFlat(angX) == true) &amp;&amp; (HidConsumerDevice_AxisFlat(angY) == true)){
        dirX = FLAT;
        dirY = FLAT;
    }
    if(dirX == FLAT &amp;&amp; dirY == FLAT)
    {
        if(((int)angX &lt; -40) &amp;&amp; (abs((int)angY) &lt; 20)) {
            led_on(Board_LED1);
            if(HidConsumerDevice_ScaleDownTime(scaleDownAngleTime, 0.3)){ 
                HidEmuKbd_enqueueMsg(HIDEMUKBD_IMU_CHANGE_EVT, HID_SUBSET_CONSUMER_VOLUME_DOWN, NULL);
                scaleDownAngleTime = 0;
            }
            scaleDownAngleTime++;
        }
        else if(((int)angX &gt; 40) &amp;&amp; (abs((int)angY) &lt; 20)){
            led_on(Board_LED1);
            if(HidConsumerDevice_ScaleDownTime(scaleDownAngleTime, 0.3)){ 
                HidEmuKbd_enqueueMsg(HIDEMUKBD_IMU_CHANGE_EVT, HID_SUBSET_CONSUMER_VOLUME_UP, NULL);
                scaleDownAngleTime = 0;
            }
            scaleDownAngleTime++;
        }
        else if((abs((int)angY) &gt; 20)){
            dirX = NONE;
            dirY = NONE;
            led_off(Board_LED2);
            led_off(Board_LED1);
        }
        else{
            led_off(Board_LED1);
        }
    }
}

void HidConsumerDevice_ConvertSensorData()
{
    gyr.x = sensorMpu9250GyroConvert((int16_t)sensorData[0] &lt;&lt; 8 | sensorData[1]);
    gyr.y = sensorMpu9250GyroConvert((int16_t)sensorData[2] &lt;&lt; 8 | sensorData[3]);
    gyr.z = sensorMpu9250GyroConvert((int16_t)sensorData[4] &lt;&lt; 8 | sensorData[5]);
    
    acc.x = sensorMpu9250AccConvert((int16_t)sensorData[6] &lt;&lt; 8 | sensorData[7]);
    acc.y = sensorMpu9250AccConvert((int16_t)sensorData[8] &lt;&lt; 8 | sensorData[9]);
    acc.z = sensorMpu9250AccConvert((int16_t)sensorData[10] &lt;&lt; 8 | sensorData[11]);
}

float lastOutput = 0;
float HidConsumerDevice_LowPassFilter(float input)
{
    float alpha = 0.5;
    float output = ((1 - alpha) * input + (alpha * lastOutput));
    lastOutput = output;
    return output;
}

void HidConsumerDevice_ProcessShake(float ang)
{
    if(((ang) &gt; 80) &amp;&amp; (axisY == ZERO)){
        axisY = ONE;
        scaleDownShakeTime = 0;
        led_on(Board_LED2);
    }
    if(((ang) &lt; -80) &amp;&amp; (axisY == ONE) &amp;&amp; (!HidConsumerDevice_ScaleDownTime(scaleDownShakeTime, 1.5))){
        axisY = TWO;
    }
    if(((ang) &gt; 80) &amp;&amp; (axisY == TWO) &amp;&amp; (!HidConsumerDevice_ScaleDownTime(scaleDownShakeTime, 1.5))){
        axisY = THREE;
    }
    if(((ang) &lt; -80) &amp;&amp; (axisY == THREE) &amp;&amp; (!HidConsumerDevice_ScaleDownTime(scaleDownShakeTime, 1.5))){
        axisY = ZERO;
        led_off(Board_LED2);
        HidEmuKbd_enqueueMsg(HIDEMUKBD_IMU_CHANGE_EVT, HID_SUBSET_CONSUMER_PLAY_PAUSE, NULL);
    }
    if (HidConsumerDevice_ScaleDownTime(scaleDownShakeTime, 1)){
        axisY = ZERO;
        led_off(Board_LED2);
    }
    scaleDownShakeTime++;
}

void Mpu9250_taskFxn(UArg a0, UArg a1)
{
    // Setup I2C for sensors
    bspI2cInit();
    // uart
    UART_init_non_default();
    // Initialize the mpu9250
    sensorMpu9250Init();
    #ifndef DEBUG_UART
    uint8_t txMsg[] = {"start"};
    UART_write(handle, txMsg, sizeof(txMsg));
    #endif //DEBUG_UART
    float angX = 0;
    float angY = 0;
    
    while (1) {
        Task_sleep(SAMPLE_TIME_MS * (1000 / Clock_tickPeriod));
        // Read gyro data
        sensorMpu9250GyroRead((uint16_t*)sensorData);
        // Read accelerometer data
        sensorMpu9250AccRead((uint16_t*)&amp;sensorData[6]);
        // convert from uint8_t to float
        HidConsumerDevice_ConvertSensorData();
        // apply low pass filter to accelerometer
        float accLowPassFilterY = HidConsumerDevice_LowPassFilter(acc.y) * 180 / M_PI;
        // apply complementary filter to accelerometer and gyroscope
        HidConsumerDevice_ComplementaryFilter(gyr, acc, &amp;angX, &amp;angY);
        // Use data to send HID commands
        HidConsumerDevice_ProcessVolumeEvent(angX, angY);  
        HidConsumerDevice_ProcessShake(accLowPassFilterY);
    }
}
</pre>
</font><p><font size="0.8"></font>
</p><p><br />
</p>
</ol>
</td></tr></tbody></table>
<h2><span class="mw-headline" id="Edit_main.c">Edit main.c</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=29" title="Edit section: Edit main.c">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<ol>

The main file needs to include the new task file, and also create the actual task in the main function.
<font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre>#include "bcomdef.h"
#include "peripheral.h"
#include "hiddev.h"
#include "hidemukbd.h" 
</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre>#include "bcomdef.h"
#include "peripheral.h"
#include "hiddev.h"
#include "hidemukbd.h"
<span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
#include "hidconsumerdevice.h"
<i></i></span>

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p>Create the task.
</p><p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre> /* Kick off application - Priority 1 */
 HidEmuKbd_createTask(); 
</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre>/* Kick off application - Priority 1 */
 HidEmuKbd_createTask();
<span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
 HidConsumerDevice_createTask();
<i></i></span>

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<p><br />
</p>
<h2><span class="mw-headline" id="Edit_hidemukbd.h">Edit hidemukbd.h</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=30" title="Edit section: Edit hidemukbd.h">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<ol>

The enqueue message function will be used by the new task, so the declaration has to be moved to the hidemukbd.h and be changed to non-static.
<font size="0.8">
<pre style="background:#CCFFCC;">uint8_t HidEmuKbd_enqueueMsg(uint16_t event, uint8_t state, uint8_t key);
</pre>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<h2><span class="mw-headline" id="Edit_hidemukbd.c_3">Edit hidemukbd.c</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=31" title="Edit section: Edit hidemukbd.c">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<ol>

<li>The enqueue message function will be used by the new task, so the declaration has to be moved to the hidemukbd.h and be changed to non-static.</li>
<p><font size="0.8">
</font></p><font size="0.8">
<pre style="background:#FFCCCC;">static uint8_t HidEmuKbd_enqueueMsg(uint16_t event, uint8_t state, uint8_t key);
</pre>
</font><p><font size="0.8"></font>
</p>
<li>The function definition has to be changed aswell.</li>
<p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
static uint8_t HidEmuKbd_enqueueMsg(uint16_t event, uint8_t key, uint8_t state)
<i></i></span>

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
uint8_t HidEmuKbd_enqueueMsg(uint16_t event, uint8_t key, uint8_t state)
<i></i></span>

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
<li>Since we have another task running the MPU-9250 specific functionality, another event id must be added so it is possible to tell a call from different tasks apart.</li>
<p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre>#define HIDEMUKBD_KEY_CHANGE_EVT              0x0001

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre>#define HIDEMUKBD_KEY_CHANGE_EVT              0x0001
<span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
#define HIDEMUKBD_IMU_CHANGE_EVT              0x0002
<i></i></span>

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
<li>We also need to add support for the new id.</li>
<p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre>static void HidEmuKbd_processAppMsg(hidEmuKbdEvt_t *pMsg)
{
  switch (pMsg-&gt;event)
  {
    case HIDEMUKBD_KEY_CHANGE_EVT:
      HidEmuKbd_handleKeys(0, pMsg-&gt;key, pMsg-&gt;state);
      break;     
    default:
      //Do nothing.
      break;
  }
}

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre>static void HidEmuKbd_processAppMsg(hidEmuKbdEvt_t *pMsg)
{
  switch (pMsg-&gt;event)
  {
    case HIDEMUKBD_KEY_CHANGE_EVT:
      HidEmuKbd_handleKeys(0, pMsg-&gt;key, pMsg-&gt;state);
      break; 
<span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
    case HIDEMUKBD_IMU_CHANGE_EVT:
      HidEmuKbd_sendReport(pMsg-&gt;key);
      HidEmuKbd_sendReport(KEY_NONE);
      break;
<i></i></span>
    default:
      //Do nothing.
      break;
  }
}

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
<li>Add functionality to send different HID commands depending on task id.</li>
<p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre> <span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i>                            </i>
static void HidEmuKbd_handleKeys(uint8_t shift, uint8_t key, uint8_t keyEvent)
{
  (void)shift;  // Intentionally unreferenced parameter
  if (key == KEY_RIGHT)
  {
     switch (keyEvent)
     {
       case BTN_EV_PRESSED:
       // Pause/Play
       HidEmuKbd_sendReport(HID_SUBSET_CONSUMER_PLAY_PAUSE);
       break;     
       case BTN_EV_LONGPRESSED:
       // Volume Down
       HidEmuKbd_sendReport(HID_SUBSET_CONSUMER_VOLUME_DOWN);
       break;  
       case BTN_EV_RELEASED:
       // Key Released.
       HidEmuKbd_sendReport(KEY_NONE);
       break;  
       default:
       // do nothing
       break;
     }
   }
   if (key == KEY_LEFT)
   {
      switch (keyEvent)
      {
       case BTN_EV_PRESSED:
       // Next Track
       HidEmuKbd_sendReport(HID_SUBSET_CONSUMER_SKIP_TRACK);
       break;        
       case BTN_EV_LONGPRESSED:
       // Volume Up
       HidEmuKbd_sendReport(HID_SUBSET_CONSUMER_VOLUME_UP);
       break;       
       case BTN_EV_RELEASED:
       // Key Released.
       HidEmuKbd_sendReport(KEY_NONE);
       break;       
       default:
       // do nothing
       break;
     }
   }
}
<i></i></span>

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
static void HidEmuKbd_handleKeys(uint8_t shift, uint8_t key, uint8_t keyEvent)
{
  (void)shift;  // Intentionally unreferenced parameter  
  if (key == KEY_RIGHT)
  {
    switch (keyEvent)
    {
      case BTN_EV_CLICKED:
        // Pause/Play
        HidEmuKbd_sendReport(HID_SUBSET_CONSUMER_PLAY_PAUSE);
        HidEmuKbd_sendReport(KEY_NONE);
        break;
      case BTN_EV_LONGPRESSED:
        break;
      case BTN_EV_RELEASED:
        // Key Released.
        HidEmuKbd_sendReport(KEY_NONE);
        break;
      default:
        // do nothing
        break;
    }
  }
  if (key == KEY_LEFT)
  {
    switch (keyEvent)
    {
      case BTN_EV_CLICKED:
        // Next Track
        HidEmuKbd_sendReport(HID_SUBSET_CONSUMER_SKIP_TRACK);
        HidEmuKbd_sendReport(KEY_NONE);
        break;
      case BTN_EV_LONGPRESSED:
        break;
      case BTN_EV_RELEASED:
        // Key Released.
        HidEmuKbd_sendReport(KEY_NONE);
        break;
      default:
        // do nothing
        break;
    }
  }
}
<i></i></span>

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<p><br />
</p>
<h2><span class="mw-headline" id="Edit_sensor_mpu9250.c">Edit sensor_mpu9250.c</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=32" title="Edit section: Edit sensor mpu9250.c">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<ol>

The sensor_mpu9250 driver is written for the SensorTag project, and includes several other files that are not needed for this project. In order to be able to exclude these files some changes has to be made. 
<font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
#include "sensor.h"
<i></i></span>

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
#include &lt;ti/sysbios/knl/Task.h&gt;
#include &lt;ti/sysbios/knl/Clock.h&gt;
<i></i></span>

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p>In order to cut out some unnecessary libraries, some defines have to be moved from those files into sensor_mpu9250.c.
</p><p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre>// Sensor selection/de-selection
#define SENSOR_SELECT()               bspI2cSelect(BSP_I2C_INTERFACE_1,SENSOR_I2C_ADDRESS)
#define SENSOR_SELECT_MAG()           bspI2cSelect(BSP_I2C_INTERFACE_1,SENSOR_MAG_I2_ADDRESS)
#define SENSOR_DESELECT()             bspI2cDeselect()

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre>// Sensor selection/de-selection
#define SENSOR_SELECT()               bspI2cSelect(BSP_I2C_INTERFACE_1,SENSOR_I2C_ADDRESS)
#define SENSOR_SELECT_MAG()           bspI2cSelect(BSP_I2C_INTERFACE_1,SENSOR_MAG_I2_ADDRESS)
#define SENSOR_DESELECT()             bspI2cDeselect()
<span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
/* Self test assertion; return false (failed) if condition is not met */
#define ST_ASSERT(cond) st( if (!(cond)) {bspI2cDeselect(); return false;} )
#define ST_ASSERT_V(cond) st( if (!(cond)) {bspI2cDeselect(); return;} )
#define st(x)      do { x } while (__LINE__ == -1)
/* Delay */
#ifdef TI_DRIVERS_I2C_INCLUDED
#define delay_ms(i) Task_sleep( ((i) * 1000) / Clock_tickPeriod )
#define MS_2_TICKS(ms) ( ((ms) * 1000) / Clock_tickPeriod )
#else
#define delay_ms(i) ( CPUdelay(8000*(i)) )
#endif
<i></i></span>

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p><br />
</p><p><font size="0.8">
</font></p><font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre> // The application may register a callback to handle interrupts
static MpuCallbackFn_t isrCallbackFn = NULL;

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre>// The application may register a callback to handle interrupts
static MpuCallbackFn_t isrCallbackFn = NULL;
 <span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
static uint8_t buffer[32];
/*******************************************************************************
 * @fn          sensorReadReg
 *
 * @brief       This function implements the I2C protocol to read from a sensor.
 *              The sensor must be selected before this routine is called.
 *
 * @param       addr - which register to read
 * @param       pBuf - pointer to buffer to place data
 * @param       nBytes - number of bytes to read
 *
 * @return      TRUE if the required number of bytes are received
 ******************************************************************************/
bool sensorReadReg(uint8_t addr, uint8_t *pBuf, uint8_t nBytes)
{
  return bspI2cWriteRead(&amp;addr,1,pBuf,nBytes);
}
/*******************************************************************************
* @fn          sensorWriteReg
* @brief       This function implements the I2C protocol to write to a sensor.
*              The sensor must be selected before this routine is called.
*
* @param       addr - which register to write
* @param       pBuf - pointer to buffer containing data to be written
* @param       nBytes - number of bytes to write
*
* @return      TRUE if successful write
*/
bool sensorWriteReg(uint8_t addr, uint8_t *pBuf, uint8_t nBytes)
{
  uint8_t i;
  uint8_t *p = buffer;
  /* Copy address and data to local buffer for burst write */
  *p++ = addr;
  for (i = 0; i &lt; nBytes; i++)
  {
    *p++ = *pBuf++;
  }
  nBytes++; 
  /* Send data */
  return bspI2cWrite(buffer,nBytes);
}
<i></i></span>

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p><p><br />
</p>
</ol>
</td></tr></tbody></table>
<h2><span class="mw-headline" id="Edit_bsp_i2c.c">Edit bsp_i2c.c</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=33" title="Edit section: Edit bsp i2c.c">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<ol>

The bsp_i2c driver is written for the SensorTag project, and includes several other files that are not needed for this project. In order to be able to exclude these files some changes has to be made. 
<font size="0.8">
<table border="1" cellpadding="5" cellspacing="1" align="none">

<tbody><tr>
<td valign="top">
<pre><span style="background-color: #FFE4E1; color:; text-align:left; line-height: 1.3em;"><i></i>
#include "sensor.h"
<i></i></span>

</pre>
</td>
<td valign="center">
<center><div style="font-size: 350%;">&#8658;</div> </center>
</td>
<td valign="top">
<pre><span style="background-color: #CCFFCC; color:; text-align:left; line-height: 1.3em;"><i></i>
#include &lt;ti/sysbios/knl/Clock.h&gt;
/* Delay */
#ifdef TI_DRIVERS_I2C_INCLUDED
#define delay_ms(i) Task_sleep( ((i) * 1000) / Clock_tickPeriod )
#define MS_2_TICKS(ms) ( ((ms) * 1000) / Clock_tickPeriod )
#else
#define delay_ms(i) ( CPUdelay(8000*(i)) )
#endif
<i></i></span>

</pre>
</td></tr></tbody></table>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<p><br />
</p><p><br />
</p>
<h2><span class="mw-headline" id="Edit_Board.c">Edit Board.c</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=34" title="Edit section: Edit Board.c">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<ol>

The board file is written for the CC2650EM and does not support I2C yet. Add this by opening the Board.c file located in the "Startup" folder in the structure tree. From here, open the CC2650EM_7ID/Board.c by right the link and chose "open CC2650EM_7ID/Board.c". Add Support for I2C.

<div class="thumb tright"><div class="thumbinner" style="width:302px;"><a href="File_CC2650EM_7ID.html" class="image"><img alt="" src="https://processors.wiki.ti.com/images/c/c9/CC2650EM_7ID.PNG" width="300" height="141" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="File_CC2650EM_7ID.html" class="internal" title="Enlarge"></a></div>CC2650EM_7ID</div></div></div>
<p><font size="0.8">
</font></p><font size="0.8">
<pre style="background:#CCFFCC;">/*
 *  ============================= I2C Begin=====================================
*/
/* Place into subsections to allow the TI linker to remove items properly */
#if defined(__TI_COMPILER_VERSION__)
#pragma DATA_SECTION(I2C_config, ".const:I2C_config")
#pragma DATA_SECTION(i2cCC26xxHWAttrs, ".const:i2cCC26xxHWAttrs")
#endif

/* Include drivers */
#include &lt;ti/drivers/i2c/I2CCC26XX.h&gt;

/* I2C objects */
I2CCC26XX_Object i2cCC26xxObjects[CC2650_I2CCOUNT];

/* I2C configuration structure, describing which pins are to be used */
const I2CCC26XX_HWAttrs i2cCC26xxHWAttrs[CC2650_I2CCOUNT] = {
    {
        .baseAddr = I2C0_BASE,
        .powerMngrId = PERIPH_I2C0,
        .intNum = INT_I2C,
        .sdaPin = Board_I2C0_SDA0,
        .sclPin = Board_I2C0_SCL0,
    }
};

const I2C_Config I2C_config[] = {
    {&amp;I2CCC26XX_fxnTable, &amp;i2cCC26xxObjects[0], &amp;i2cCC26xxHWAttrs[0]},
    {NULL, NULL, NULL}
};
/*
 *  ========================== I2C end =========================================
*/

</pre>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<h2><span class="mw-headline" id="Edit_Board.h_2">Edit Board.h</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=35" title="Edit section: Edit Board.h">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<table width="1000px">
<tbody><tr><td>
<ol>

The board file is written for the CC2650EM and does not support I2C yet. Add this to the Board.h by right the link and chose "open Board.h" from the Board.c file you are currently in.

<font size="0.8">
<pre style="background:#CCFFCC;">

/* I2C */
#define Board_I2C0_SDA0             IOID_5
#define Board_I2C0_SCL0             IOID_6

#define Board_I2C0_SDA1             IOID_8
#define Board_I2C0_SCL1             IOID_9

#define Board_MPU_POWER             IOID_12
#define Board_MPU_POWER_ON          1
#define Board_MPU_POWER_OFF         0

</pre>
</font><p><font size="0.8"></font>
</p>
</ol>
</td></tr></tbody></table>
<h1><span class="mw-headline" id="Tutorial_Step_7:_Connect_and_Test">Tutorial Step 7: Connect and Test</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit&amp;section=36" title="Edit section: Tutorial Step 7: Connect and Test">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<p>Compile and run the code. Instead of connecting the SensorTag to the Bluetooth dongle, now turn on Bluetooth on your phone (make sure to have a phone with Bluetooth 4.0 or above) and pair with HID keyboard. 
</p>
<div class="thumb tnone"><div class="thumbinner" style="width:302px;"><a href="File_Phone_hid_keyboard.html" class="image"><img alt="" src="https://processors.wiki.ti.com/images/7/74/Phone_hid_keyboard.jpg" width="300" height="190" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="File_Phone_hid_keyboard.html" class="internal" title="Enlarge"></a></div>Hid Keyboard in the Bluetooth explorer</div></div></div>
<p>Start any music application and use the buttons to play, pause and skip song. The volume can be raised or lowered by first holding the SensorTag completely flat, and then tilt it back and forth sideways. The function of keeping it flat in the beginning is to avoid sending HID reports unintentionally. The red LED will flash when volume reports. The music can also be paused and played by shaking the SensorTag back and forth about three times sideways. When registering shakes, the green led will flash.
</p>
<div class="thumb tnone"><div class="thumbinner" style="width:502px;"><a href="File_SensorTagtilt.html" class="image"><img alt="" src="https://processors.wiki.ti.com/images/6/69/SensorTagtilt.jpg" width="500" height="213" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="File_SensorTagtilt.html" class="internal" title="Enlarge"></a></div>SensorTag when flat and tilted</div></div></div>

<!-- 
NewPP limit report
Cached time: 20201201050549
Cache expiry: 86400
Dynamic content: false
CPU time usage: 0.235 seconds
Real time usage: 0.246 seconds
Preprocessor visited node count: 1431/1000000
Preprocessor generated node count: 3905/1000000
Post‐expand include size: 88535/2097152 bytes
Template argument size: 74260/2097152 bytes
Highest expansion depth: 4/40
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 12192/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%   40.104      1 -total
 89.67%   35.961     28 Template:Code2Code
 68.25%   27.371     49 Template:ColorCode
  6.42%    2.573     84 Template:=
-->
</div>
<!-- Saved in parser cache with key procwiki:pcache:idhash:39139-0!canonical and timestamp 20201201050549 and revision id 205370
 -->
<div class='hf-nsfooter' id='hf-nsfooter-'><table style="text-align:center; background:white; width:100%; text-align:left; height: 65px border-top: 1px solid; border-bottom: 1px solid; border-left: 1px solid; border-right: 1px solid; border-width: 1px; border-style: solid;">
<tr>
<td width="305px"><a href="File_E2e.html" class="image"><img alt="E2e.jpg" src="https://processors.wiki.ti.com/images/8/82/E2e.jpg" width="305" height="63" /></a>
</td>
<td>{{
<ol><li>switchcategory:MultiCore=</li></ol>
<ul><li>For technical support on MultiCore devices, please post your questions in the <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/dsp/c6000_multi-core_dsps/default.aspx">C6000 MultiCore Forum</a></li>
<li>For questions related to the BIOS MultiCore SDK (MCSDK), please use the <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/embedded/f/355.aspx">BIOS Forum</a></li></ul>
<p>Please post only comments related to the article <b>HIDEmuKbd SensorTag</b> here.<i></i>
</p>
</td>
<td>Keystone=
<ul><li>For technical support on MultiCore devices, please post your questions in the <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/dsp/c6000_multi-core_dsps/default.aspx">C6000 MultiCore Forum</a></li>
<li>For questions related to the BIOS MultiCore SDK (MCSDK), please use the <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/embedded/f/355.aspx">BIOS Forum</a></li></ul>
<p>Please post only comments related to the article <b>HIDEmuKbd SensorTag</b> here.<i></i>
</p>
</td>
<td>C2000=<i>For technical support on the C2000 please post your questions on <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/microcontrollers/tms320c2000_32-bit_real-time_mcus/f/171.aspx">The C2000 Forum</a>. Please post only comments about the article <b>HIDEmuKbd SensorTag</b> here.</i>
</td>
<td>DaVinci=<i>For technical support on DaVincoplease post your questions on <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/dsp/davinci_digital_media_processors/default.aspx">The DaVinci Forum</a>. Please post only comments about the article <b>HIDEmuKbd SensorTag</b> here.</i>
</td>
<td>MSP430=<i>For technical support on MSP430 please post your questions on <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/microcontrollers/msp43016-bit_ultra-low_power_mcus/default.aspx">The MSP430 Forum</a>. Please post only comments about the article <b>HIDEmuKbd SensorTag</b> here.</i>
</td>
<td>OMAP35x=<i>For technical support on OMAP please post your questions on <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/dsp/omap_applications_processors/default.aspx">The OMAP Forum</a>. Please post only comments about the article <b>HIDEmuKbd SensorTag</b> here.</i>
</td>
<td>OMAPL1=<i>For technical support on OMAP please post your questions on <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/dsp/omap_applications_processors/default.aspx">The OMAP Forum</a>. Please post only comments about the article <b>HIDEmuKbd SensorTag</b> here.</i>
</td>
<td>MAVRK=<i>For technical support on MAVRK please post your questions on <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/development_tools/mavrk/default.aspx">The MAVRK Toolbox Forum</a>. Please post only comments about the article <b>HIDEmuKbd SensorTag</b> here.</i>
</td>
<td><i>For technical support please post your questions at <a rel="nofollow" class="external text" href="http://e2e.ti.com/">http://e2e.ti.com</a>. Please post only comments about the article <b>HIDEmuKbd SensorTag</b> here.</i>
<p>}}
</p>
</td></tr></table>
<table style="border-style:solid; border-width:1px; text-align:center; width:100%;">

<tr style="font-size:150%;">
<td rowspan="2"><a href="File_Hyperlink_blue.html" class="image"><img alt="Hyperlink blue.png" src="https://processors.wiki.ti.com/images/9/9f/Hyperlink_blue.png" width="96" height="96" /></a>
</td>
<td><b>Links</b>
</td></tr>
<tr>
<td>
<table style="text-align: left;">
<tr>
<td style="padding-right: 10px; vertical-align: top;">
<p><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/amplifier_and_linear.page">Amplifiers &amp; Linear</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/audio/audio_overview.page">Audio</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/rfif.page">Broadband RF/IF &amp; Digital Radio</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/clocksandtimers/clocks_and_timers.page">Clocks &amp; Timers</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/dataconverters/data_converter.page">Data Converters</a>
</p>
</td>
<td style="padding-right: 10px; vertical-align: top;">
<p><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/mems/mems.page">DLP &amp; MEMS</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/high_reliability.page">High-Reliability</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/interface/interface.page">Interface</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/logic/home_overview.page">Logic</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/powermanagement/power_portal.page">Power Management</a>
</p>
</td>
<td style="padding-right: 10px; vertical-align: top;">
<p><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/dsp/embedded_processor.page">Processors</a>
</p>
<ul><li><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/dsp/arm.page">ARM Processors</a></li>
<li><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/dsp/home.page">Digital Signal Processors (DSP)</a></li>
<li><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/microcontroller/home.page">Microcontrollers (MCU)</a></li>
<li><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/omap-applications-processors/the-omap-experience.page">OMAP Applications Processors</a></li></ul>
</td>
<td style="padding-right: 10px; vertical-align: top;">
<p><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/switches_and_multiplexers.page">Switches &amp; Multiplexers</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/temperature_sensor.page">Temperature Sensors &amp; Control ICs</a><br/>
<a rel="nofollow" class="external text" href="http://focus.ti.com/wireless/docs/wirelessoverview.tsp?familyId=2003&amp;sectionId=646&amp;tabId=2735">Wireless Connectivity</a>
</p>
</td></tr></table>
</td></tr></table>
<div id="tiPrivacy"></div>
</div></div>					<div class="printfooter">
						Retrieved from "<a dir="ltr" href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;oldid=205370">https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;oldid=205370</a>"					</div>
				<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="Special_Categories.html" title="Special:Categories">Categories</a>: <ul><li><a href="Category_Bluetooth_/_Bluetooth_Low_Energy.html" title="Category:Bluetooth / Bluetooth Low Energy">Bluetooth / Bluetooth Low Energy</a></li><li><a href="https://processors.wiki.ti.com/index.php?title=Category:Template_examples&amp;action=edit&amp;redlink=1" class="new" title="Category:Template examples (page does not exist)">Template examples</a></li></ul></div></div>				<div class="visualClear"></div>
							</div>
		</div>
		<div id="mw-navigation">
			<h2>Navigation menu</h2>
			<div id="mw-head">
									<div id="p-personal" role="navigation" class="" aria-labelledby="p-personal-label">
						<h3 id="p-personal-label">Personal tools</h3>
						<ul>
							<li id="pt-login"><a href="https://processors.wiki.ti.com/index.php?title=Special:UserLogin&amp;returnto=HIDEmuKbd+SensorTag" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li><li id="pt-createaccount"><a href="Special_RequestAccount.html" title="You are encouraged to create an account and log in; however, it is not mandatory">Request account</a></li>						</ul>
					</div>
									<div id="left-navigation">
										<div id="p-namespaces" role="navigation" class="vectorTabs" aria-labelledby="p-namespaces-label">
						<h3 id="p-namespaces-label">Namespaces</h3>
						<ul>
							<li id="ca-nstab-main" class="selected"><span><a href="HIDEmuKbd_SensorTag.html" title="View the content page [c]" accesskey="c">Page</a></span></li><li id="ca-talk"><span><a href="Talk_HIDEmuKbd_SensorTag.html" rel="discussion" title="Discussion about the content page [t]" accesskey="t">Discussion</a></span></li>						</ul>
					</div>
										<div id="p-variants" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-variants-label">
												<input type="checkbox" class="vectorMenuCheckbox" aria-labelledby="p-variants-label" />
						<h3 id="p-variants-label">
							<span>Variants</span>
						</h3>
						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
									</div>
				<div id="right-navigation">
										<div id="p-views" role="navigation" class="vectorTabs" aria-labelledby="p-views-label">
						<h3 id="p-views-label">Views</h3>
						<ul>
							<li id="ca-view" class="collapsible selected"><span><a href="HIDEmuKbd_SensorTag.html">Read</a></span></li><li id="ca-viewsource" class="collapsible"><span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></span></li><li id="ca-history" class="collapsible"><span><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=history" title="Past revisions of this page [h]" accesskey="h">View history</a></span></li>						</ul>
					</div>
										<div id="p-cactions" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-cactions-label">
						<input type="checkbox" class="vectorMenuCheckbox" aria-labelledby="p-cactions-label" />
						<h3 id="p-cactions-label"><span>More</span></h3>
						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
										<div id="p-search" role="search">
						<h3>
							<label for="searchInput">Search</label>
						</h3>
						<form action="https://processors.wiki.ti.com/index.php" id="searchform">
							<div id="simpleSearch">
								<input type="search" name="search" placeholder="Search Texas Instruments Wiki" title="Search Texas Instruments Wiki [f]" accesskey="f" id="searchInput"/><input type="hidden" value="Special:Search" name="title"/><input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton mw-fallbackSearchButton"/><input type="submit" name="go" value="Go" title="Go to a page with this exact name if it exists" id="searchButton" class="searchButton"/>							</div>
						</form>
					</div>
									</div>
			</div>
			<div id="mw-panel">
				<div id="p-logo" role="banner"><a class="mw-wiki-logo" href="Main_Page.html"  title="Visit the main page"></a></div>
						<div class="portal" role="navigation" id="p-navigation" aria-labelledby="p-navigation-label">
			<h3 id="p-navigation-label">Navigation</h3>
			<div class="body">
								<ul>
					<li id="n-mainpage"><a href="Main_Page.html" title="Visit the main page [z]" accesskey="z">Main Page</a></li><li id="n-All-pages"><a href="Special_AllPages.html">All pages</a></li><li id="n-All-categories"><a href="Special_Categories.html">All categories</a></li><li id="n-recentchanges"><a href="Special_RecentChanges.html" title="A list of recent changes in the wiki [r]" accesskey="r">Recent changes</a></li><li id="n-randompage"><a href="Package_Reflow_Profiles.html" title="Load a random page [x]" accesskey="x">Random page</a></li><li id="n-help"><a href="https://www.mediawiki.org/wiki/Special:MyLanguage/Help:Contents" title="The place to find out">Help</a></li>				</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id="p-tb" aria-labelledby="p-tb-label">
			<h3 id="p-tb-label">Toolbox</h3>
			<div class="body">
								<ul>
					<li id="t-whatlinkshere"><a href="Special_WhatLinksHere/HIDEmuKbd_SensorTag.html" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li><li id="t-recentchangeslinked"><a href="Special_RecentChangesLinked/HIDEmuKbd_SensorTag.html" rel="nofollow" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li><li id="t-specialpages"><a href="Special_SpecialPages.html" title="A list of all special pages [q]" accesskey="q">Special pages</a></li><li id="t-print"><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li><li id="t-permalink"><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;oldid=205370" title="Permanent link to this revision of the page">Permanent link</a></li><li id="t-info"><a href="https://processors.wiki.ti.com/index.php?title=HIDEmuKbd_SensorTag&amp;action=info" title="More information about this page">Page information</a></li>				</ul>
							</div>
		</div>
				</div>
		</div>
				<div id="footer" role="contentinfo">
						<ul id="footer-info">
								<li id="footer-info-lastmod"> This page was last edited on 26 August 2015, at 14:34.</li>
								<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike</a> unless otherwise noted.</li>
							</ul>
						<ul id="footer-places">
								<li id="footer-places-privacy"><a href="Project_Privacy_policy.html" title="Project:Privacy policy">Privacy policy</a></li>
								<li id="footer-places-about"><a href="Project_About.html" title="Project:About">About Texas Instruments Wiki</a></li>
								<li id="footer-places-disclaimer"><a href="Project_General_disclaimer.html" title="Project:General disclaimer">Disclaimers</a></li>
								<li id="footer-places-termsofservice"><a href="Project_Terms_of_Service.html" title="Project:Terms of Service">Terms of Use</a></li>
							</ul>
										<ul id="footer-icons" class="noprint">
										<li id="footer-copyrightico">
						<a href="http://creativecommons.org/licenses/by-sa/3.0/"><img src="https://processors.wiki.ti.com/resources/assets/licenses/cc-by-sa.png" alt="Creative Commons Attribution-ShareAlike" width="88" height="31"/></a>					</li>
										<li id="footer-poweredbyico">
						<a href="http://www.mediawiki.org/"><img src="https://processors.wiki.ti.com/resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31"/></a>					</li>
									</ul>
						<div style="clear: both;"></div>
		</div>
		<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgPageParseReport":{"limitreport":{"cputime":"0.235","walltime":"0.246","ppvisitednodes":{"value":1431,"limit":1000000},"ppgeneratednodes":{"value":3905,"limit":1000000},"postexpandincludesize":{"value":88535,"limit":2097152},"templateargumentsize":{"value":74260,"limit":2097152},"expansiondepth":{"value":4,"limit":40},"expensivefunctioncount":{"value":0,"limit":100},"unstrip-depth":{"value":0,"limit":20},"unstrip-size":{"value":12192,"limit":5000000},"timingprofile":["100.00%   40.104      1 -total"," 89.67%   35.961     28 Template:Code2Code"," 68.25%   27.371     49 Template:ColorCode","  6.42%    2.573     84 Template:="]},"cachereport":{"timestamp":"20201201050549","ttl":86400,"transientcontent":false}}});});</script><script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgBackendResponseTime":496});});</script>
	</body>

<!-- Mirrored from processors.wiki.ti.com/index.php/HIDEmuKbd_SensorTag by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 01 Dec 2020 08:20:24 GMT -->
</html>
