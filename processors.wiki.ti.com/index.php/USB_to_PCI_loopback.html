<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">

<!-- Mirrored from processors.wiki.ti.com/index.php/USB_to_PCI_loopback by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 01 Dec 2020 08:18:58 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="UTF-8"/>
<title>USB to PCI loopback - Texas Instruments Wiki</title>
<script>document.documentElement.className = document.documentElement.className.replace( /(^|\s)client-nojs(\s|$)/, "$1client-js$2" );</script>
<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"USB_to_PCI_loopback","wgTitle":"USB to PCI loopback","wgCurRevisionId":20169,"wgRevisionId":20169,"wgArticleId":421,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Linux","USB","PCI"],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"USB_to_PCI_loopback","wgRelevantArticleId":421,"wgRequestId":"b2f23df5ace58a336cd7409d","wgIsProbablyEditable":false,"wgRelevantPageIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[]});mw.loader.state({"site.styles":"ready","noscript":"ready","user.styles":"ready","user":"ready","user.options":"ready","user.tokens":"loading","mediawiki.page.gallery.styles":"ready","mediawiki.legacy.shared":"ready","mediawiki.legacy.commonPrint":"ready","mediawiki.sectionAnchor":"ready","mediawiki.skinning.interface":"ready","skins.vector.styles":"ready"});mw.loader.implement("user.tokens@19o3a1s",function($,jQuery,require,module){/*@nomin*/mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});
});mw.loader.load(["site","mediawiki.page.startup","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.toc","mediawiki.searchSuggest","skins.vector.js"]);});</script>
<link rel="stylesheet" href="https://processors.wiki.ti.com/load.php?debug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint%2Cshared%7Cmediawiki.page.gallery.styles%7Cmediawiki.sectionAnchor%7Cmediawiki.skinning.interface%7Cskins.vector.styles&amp;only=styles&amp;skin=vector"/>
<script async="" src="https://processors.wiki.ti.com/load.php?debug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=vector"></script>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="https://processors.wiki.ti.com/load.php?debug=false&amp;lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=vector"/>
<meta name="generator" content="MediaWiki 1.31.6"/>
<link rel="shortcut icon" href="https://processors.wiki.ti.com/favicon.ico"/>
<link rel="search" type="application/opensearchdescription+xml" href="https://processors.wiki.ti.com/opensearch_desc.php" title="Texas Instruments Wiki (en)"/>
<link rel="EditURI" type="application/rsd+xml" href="https://processors.wiki.ti.com/api.php?action=rsd"/>
<link rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"/>
<link rel="alternate" type="application/atom+xml" title="Texas Instruments Wiki Atom feed" href="https://processors.wiki.ti.com/index.php?title=Special:RecentChanges&amp;feed=atom"/>
<!--[if lt IE 9]><script src="/load.php?debug=false&amp;lang=en&amp;modules=html5shiv&amp;only=scripts&amp;skin=Vector&amp;sync=1"></script><![endif]-->
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-USB_to_PCI_loopback rootpage-USB_to_PCI_loopback skin-vector action-view">		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<div id="content" class="mw-body" role="main">
			<a id="top"></a>
			<div id="siteNotice" class="mw-body-content"><div id="localNotice" lang="en" dir="ltr"><div class="mw-parser-output"><p><br />
<span style="color:#ff0000"><b>NOTICE: The Processors Wiki will End-of-Life on January 15, 2021. It is recommended to download any files or other content you may need that are hosted on processors.wiki.ti.com. The site is now set to read only.</b></span>
</p></div></div></div><div class="mw-indicators mw-body-content">
</div>
<h1 id="firstHeading" class="firstHeading" lang="en">USB to PCI loopback</h1>			<div id="bodyContent" class="mw-body-content">
				<div id="siteSub" class="noprint">From Texas Instruments Wiki</div>				<div id="contentSub"></div>
								<div id="jump-to-nav" class="mw-jump">
					Jump to:					<a href="#mw-head">navigation</a>, 					<a href="#p-search">search</a>
				</div>
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div class="mw-parser-output"><p><br />
</p>
<div id="toc" class="toc"><div class="toctitle" lang="en" dir="ltr"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Introduction"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#System_Design"><span class="tocnumber">1.1</span> <span class="toctext">System Design</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#Requirements"><span class="tocnumber">1.2</span> <span class="toctext">Requirements</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-4"><a href="#USB_Host_Setup"><span class="tocnumber">2</span> <span class="toctext">USB Host Setup</span></a>
<ul>
<li class="toclevel-2 tocsection-5"><a href="#Kernel_Configuration"><span class="tocnumber">2.1</span> <span class="toctext">Kernel Configuration</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Test_Application"><span class="tocnumber">2.2</span> <span class="toctext">Test Application</span></a>
<ul>
<li class="toclevel-3 tocsection-7"><a href="#Design"><span class="tocnumber">2.2.1</span> <span class="toctext">Design</span></a></li>
<li class="toclevel-3 tocsection-8"><a href="#Compilation"><span class="tocnumber">2.2.2</span> <span class="toctext">Compilation</span></a></li>
<li class="toclevel-3 tocsection-9"><a href="#Usage"><span class="tocnumber">2.2.3</span> <span class="toctext">Usage</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-10"><a href="#DM6467_Setup"><span class="tocnumber">3</span> <span class="toctext">DM6467 Setup</span></a>
<ul>
<li class="toclevel-2 tocsection-11"><a href="#Kernel_Configuration_2"><span class="tocnumber">3.1</span> <span class="toctext">Kernel Configuration</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#USB_User_Space_Driver"><span class="tocnumber">3.2</span> <span class="toctext">USB User Space Driver</span></a>
<ul>
<li class="toclevel-3 tocsection-13"><a href="#Design_2"><span class="tocnumber">3.2.1</span> <span class="toctext">Design</span></a>
<ul>
<li class="toclevel-4 tocsection-14"><a href="#simple_source_thread"><span class="tocnumber">3.2.1.1</span> <span class="toctext">simple_source_thread</span></a></li>
<li class="toclevel-4 tocsection-15"><a href="#simple_sink_thread"><span class="tocnumber">3.2.1.2</span> <span class="toctext">simple_sink_thread</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-16"><a href="#Compilation_2"><span class="tocnumber">3.2.2</span> <span class="toctext">Compilation</span></a></li>
<li class="toclevel-3 tocsection-17"><a href="#Usage_2"><span class="tocnumber">3.2.3</span> <span class="toctext">Usage</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-18"><a href="#PCI_Slave_Driver"><span class="tocnumber">3.3</span> <span class="toctext">PCI Slave Driver</span></a>
<ul>
<li class="toclevel-3 tocsection-19"><a href="#Design_3"><span class="tocnumber">3.3.1</span> <span class="toctext">Design</span></a></li>
<li class="toclevel-3 tocsection-20"><a href="#Usage_3"><span class="tocnumber">3.3.2</span> <span class="toctext">Usage</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-21"><a href="#PCI_Host_Setup"><span class="tocnumber">4</span> <span class="toctext">PCI Host Setup</span></a>
<ul>
<li class="toclevel-2 tocsection-22"><a href="#PCI_Host_Driver"><span class="tocnumber">4.1</span> <span class="toctext">PCI Host Driver</span></a>
<ul>
<li class="toclevel-3 tocsection-23"><a href="#Design_4"><span class="tocnumber">4.1.1</span> <span class="toctext">Design</span></a></li>
<li class="toclevel-3 tocsection-24"><a href="#Compilation_3"><span class="tocnumber">4.1.2</span> <span class="toctext">Compilation</span></a></li>
<li class="toclevel-3 tocsection-25"><a href="#Usage_4"><span class="tocnumber">4.1.3</span> <span class="toctext">Usage</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-26"><a href="#PCI_Host_Application"><span class="tocnumber">4.2</span> <span class="toctext">PCI Host Application</span></a>
<ul>
<li class="toclevel-3 tocsection-27"><a href="#Design_5"><span class="tocnumber">4.2.1</span> <span class="toctext">Design</span></a></li>
<li class="toclevel-3 tocsection-28"><a href="#Usage_5"><span class="tocnumber">4.2.2</span> <span class="toctext">Usage</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-29"><a href="#Putting_it_all_Together"><span class="tocnumber">5</span> <span class="toctext">Putting it all Together</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Introduction">Introduction</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=1" title="Edit section: Introduction">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>The purpose of this sample project is to demonstrate how to use the DM6467 to act as a bridge between USB and PCI.  This example can be easily extended to bridge USB to another peripheral such as SD/MMC, HDD, or EMAC.  The main components of this example are:
</p>
<ul><li>A USB host application that will send data to the DM6467.  This application will time how long it takes for the data to come back over USB.</li>
<li>A User Space USB driver running on the gadgetFS file system on the DM6467 which transfers incoming data to the PCI device.</li>
<li>A PCI host application that boots the DM6467 over PCI and is responsible for reading and writing data over PCI.</li></ul>
<h3><span class="mw-headline" id="System_Design">System Design</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=2" title="Edit section: System Design">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>The design of this system is best shown in the below diagram.  The steps are:
</p>
<ol><li>USB host sends a packet of data to the DM6467</li>
<li>DM6467 transfers data to PCI buffer and notifies PCI host that data is available</li>
<li>PCI host reads the data over PCI and then writes the data back over PCI to DM6467</li>
<li>PCI Host notifies DM6467 that the data is available</li>
<li>DM6467 writes the data to the USB Host and the USB Host reports the trip time.</li></ol>
<p><a href="File_USB_PCI_loopback_system_design.html" class="image"><img alt="USB PCI loopback system design.jpg" src="https://processors.wiki.ti.com/images/e/ec/USB_PCI_loopback_system_design.jpg" width="800" height="400" /></a>
</p>
<h3><span class="mw-headline" id="Requirements">Requirements</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=3" title="Edit section: Requirements">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<ol><li>USB Host device.  This can be a PC (although you may notice latency issues if the PC is under load).  In this setup a DM6446 EVM was used as the USB Host.</li>
<li>DM6467 with a kernel configured for PCI slave and USB peripheral mode.  Details on this configuration can be found in the sections below.</li>
<li>A PCI Host to boot the DM6467.</li>
<li>The DM6467 must be set to boot from PCI.  This can be done by setting SW3[1:8] 01000000 where 0=off and 1=on.</li>
<li>USB cable to connect the USB Host and DM6467.</li>
<li>You may need a PCI extender card like the one pictured below if you cannot find a USB cable that can be used with the EVM while it is plugged into the PCI slot.  The extender will allow a normal USB cable to be plugged into the USB connector while the PCI is in use.</li>
<li>The <a href="https://processors.wiki.ti.com/images/9/9f/USB_to_PCI_loopback.tar.gz" class="internal" title="USB to PCI loopback.tar.gz">USB to PCI loopback</a> sample code.  This tarball contains the code for the USB host, DM6467, and PCI Host devices.</li></ol>
<ul class="gallery mw-gallery-traditional">
		<li class="gallerybox" style="width: 155px"><div style="width: 155px">
			<div class="thumb" style="width: 150px;"><div style="margin:30px auto;"><a href="File_USB_PCI_loopback_PCI_extender.html" class="image"><img alt="" src="https://processors.wiki.ti.com/images/c/c7/USB_PCI_loopback_PCI_extender.jpg" width="120" height="90" /></a></div></div>
			<div class="gallerytext">
<p>PCI extender
</p>
			</div>
		</div></li>
		<li class="gallerybox" style="width: 155px"><div style="width: 155px">
			<div class="thumb" style="width: 150px;"><div style="margin:30px auto;"><a href="File_USB_PCI_loopback_USB_cable.html" class="image"><img alt="" src="https://processors.wiki.ti.com/images/1/1f/USB_PCI_loopback_USB_cable.jpg" width="120" height="90" /></a></div></div>
			<div class="gallerytext">
<p>USB cable connector
</p>
			</div>
		</div></li>
</ul>
<h2><span class="mw-headline" id="USB_Host_Setup">USB Host Setup</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=4" title="Edit section: USB Host Setup">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>This section will cover how to configure the USB host applications and drivers for the USB to PCI loopback testing.  This section also contains information about the design and usage of the USB host application that moves data to/from the DM6467 over USB.
</p>
<h3><span class="mw-headline" id="Kernel_Configuration">Kernel Configuration</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=5" title="Edit section: Kernel Configuration">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>In order to easily communicate with the GadgetFS driver on the DM6467, generate data packets, and get timing information the usbtest driver is used.  On some systems such as RedHat Enterprise Linux 4 this driver is already provided as a loadable module.  However, if a DaVinci device is being used as the USB Host (as in this setup) then the usbtest driver must be configured as part of the kernel (as either static or a module).  The usb test driver can be found in the kernel configuration under <i>Device Drivers</i> -&gt; <i>USB Support</i> -&gt; <i>USB testing driver (DEVELOPMENT)</i>.
</p>
<h3><span class="mw-headline" id="Test_Application">Test Application</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=6" title="Edit section: Test Application">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>The USB host test application is named USB_to_PCI_loop_test.c and is located in the USB_Host_App directory of the sample code package.  This application is based on the <a rel="nofollow" class="external text" href="http://www.linux-usb.org/usbtest/testusb.c">testusb.c</a> application from <a rel="nofollow" class="external free" href="http://www.linux-usb.org/usbtest/">http://www.linux-usb.org/usbtest/</a>.  This application is designed to work with the usbtest driver to send data over the USB connection and get timing data.  It has be modified as described in the design section below.
</p>
<h4><span class="mw-headline" id="Design">Design</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=7" title="Edit section: Design">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p>The handle_testdev function has been replaced with a function called run_loopback_test.  The run_loopback_test function performs the following operations:
</p>
<ol><li>Initialize timer structures</li>
<li>For number of iterations do
<ol><li>Request usbtest module to write 512 bytes of data.</li>
<li>Record amount of time required for USB write.</li>
<li>Request usbtest module to read 512 bytes of data.  This operation will block until the GadgetFS USB driver on the DM6467 has data for the USB Host to read.</li>
<li>Add the amount of time required for the USB read to the time for one loop</li></ol></li>
<li>Report timing statistics</li></ol>
<h4><span class="mw-headline" id="Compilation">Compilation</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=8" title="Edit section: Compilation">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p>This application should be compiled on the USB host.  A Makefile is provided so the build procedure is to copy the USB_Host_App directory to the USB Host system and type <i>make</i> in the USB_Host_App directory.  This will create a binary executable called USB_to_PCI_loop_test.o
</p>
<h4><span class="mw-headline" id="Usage">Usage</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=9" title="Edit section: Usage">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p>The USB_to_PCI_loop_test.o application should be invoked using the following command line:
</p>
<pre> ./USB_to_PCI_loop_test.o -a -c 1
</pre>
<p>The -a option specifies to discover all USB devices connected (In this case only the DM6467 should be connected) and the -c option specifies the number of iterations.
</p>
<pre> NOTE:  The reason the number of iterations is set to one in the above example is that using more than 1 iteration at a
        time is not currently supported.  It is possible to run the single loop test multiple times but with only 1 
        iteration per run.
</pre>
<h2><span class="mw-headline" id="DM6467_Setup">DM6467 Setup</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=10" title="Edit section: DM6467 Setup">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>This section covers how to setup the DM6467 to accept data from the USB and PCI peripherals.
</p>
<h3><span class="mw-headline" id="Kernel_Configuration_2">Kernel Configuration</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=11" title="Edit section: Kernel Configuration">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>In order for the DM6467 to communicate over USB and PCI the kernel must be configured for USB GadgetFS and PCI.  The steps below cover how to configure the kernel.
</p>
<ol><li>Create a copy of the LSP kernel.  In this example the kernel will be in the /home/user/kernel/ti-davinci directory.</li>
<li>Apply this <a href="https://processors.wiki.ti.com/images/0/0d/USB_PCI_loopback_gadgetfs_highspeed.patch.gz" class="internal" title="USB PCI loopback gadgetfs highspeed.patch.gz">USB GadgetFS highspeed patch</a> to enable the GadgetFS driver in the DaVinci kernel to properly act as a highspeed device.  The below instructions assume you have downloaded the patch to your /tmp directory
<dl><dd>cd /home/user/kernel/ti-davinci</dd>
<dd>gunzip /tmp/USB_PCI_loopback_gadgetfs_highspeed.patch.gz</dd>
<dd>patch -p1 &lt; /tmp/USB_PCI_loopback_gadgetfs_highspeed.patch</dd></dl></li>
<li>Configure the kernel with the DM6467 defaults
<dl><dd>make davinci_dm646x_defconfig</dd></dl></li>
<li>Open the kernel configuration utility.  In this example I am using xconfig.
<dl><dd>make xconfig</dd></dl></li>
<li>Enable the DM6467 PCI driver.  This driver is located under <i>Device Drivers</i> -&gt; <i>Character devices</i> -&gt; <i>DaVinci PCI Module Support</i>.  In this example the driver is configured as a module.  You should see a screen similar to the one below.
<dl><dd></dd>
<dd><div class="thumb tnone"><div class="thumbinner" style="width:302px;"><a href="File_USB_PCI_loopback_PCI_Slave_config.html" class="image"><img alt="USB PCI loopback PCI Slave config.jpg" src="https://processors.wiki.ti.com/images/c/c9/USB_PCI_loopback_PCI_Slave_config.jpg" width="300" height="209" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="File_USB_PCI_loopback_PCI_Slave_config.html" class="internal" title="Enlarge"></a></div></div></div></div></dd>
<dd></dd></dl></li>
<li>Enable GadgetFS support.  This requires that you enable <i>Device Drivers</i> -&gt; <i>USB support</i> -&gt; <i>USB Gadget Support</i> -&gt; <i>Support for USB Gadgets</i> AND <i>Device Drivers</i> -&gt; <i>USB support</i> -&gt; <i>USB Gadget Support</i> -&gt; <i>Support for USB Gadgets</i> -&gt; <i>USB Gadget Drivers</i> -&gt; <i>Gadget Filesystem(EXPERIMENTAL)(NEW)</i>.  In this example these options are build as modules.  You should see a screen similar to the one below.
<dl><dd></dd>
<dd><div class="thumb tnone"><div class="thumbinner" style="width:302px;"><a href="File_USB_PCI_loopback_USB_gadgetfs_config.html" class="image"><img alt="USB PCI loopback USB gadgetfs config.jpg" src="https://processors.wiki.ti.com/images/d/d5/USB_PCI_loopback_USB_gadgetfs_config.jpg" width="300" height="210" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="File_USB_PCI_loopback_USB_gadgetfs_config.html" class="internal" title="Enlarge"></a></div></div></div></div></dd>
<dd></dd></dl></li>
<li>Configure the DaVinci USB controller for peripheral mode.  This requires setting <i>Device Drivers</i> -&gt; <i>USB support</i> -&gt; <i><a href="Inventra_HDRC_USB_Controller.html" title="Inventra HDRC USB Controller">Inventra USB Highspeed Dual Role Controller</a> Support</i> -&gt; <i>Driver Mode</i> -&gt; <i>USB Peripheral (gadget stack)</i>.  You should see a screen similar to the one below.
<dl><dd></dd>
<dd><div class="thumb tnone"><div class="thumbinner" style="width:302px;"><a href="File_USB_PCI_loopback_USB_controller_config.html" class="image"><img alt="USB PCI loopback USB controller config.jpg" src="https://processors.wiki.ti.com/images/3/3e/USB_PCI_loopback_USB_controller_config.jpg" width="300" height="209" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="File_USB_PCI_loopback_USB_controller_config.html" class="internal" title="Enlarge"></a></div></div></div></div></dd>
<dd></dd></dl></li>
<li>Compile the kernel uImage and copy it to a tftp directory.  In this case the default tftpboot directory is used and the kernel image is named uImage-pcigadgetfs.
<dl><dd>make uImage</dd>
<dd>cp arch/arm/boot/uImage /tftpboot/uImage-pcigadgetfs</dd></dl></li>
<li>Compile the kernel modules which includes the PCI slave driver and the USB GadgetFS driver.
<dl><dd>make modules</dd></dl></li>
<li>Install the modules to your target file system.  In this example the root of the file system is an NFS file system located at /home/user/filesys
<dl><dd>make modules_install INSTALL_MOD_PATH=/home/user/filesys</dd></dl></li></ol>
<h3><span class="mw-headline" id="USB_User_Space_Driver">USB User Space Driver</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=12" title="Edit section: USB User Space Driver">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>The user space driver being used in this example is based on the <a rel="nofollow" class="external text" href="http://www.linux-usb.org/gadget/usb.c">usb.c</a> driver from <a rel="nofollow" class="external autonumber" href="http://www.linux-usb.org/gadget">[1]</a>.  This driver also requires the <a rel="nofollow" class="external text" href="http://www.linux-usb.org/gadget/usbstring.c">usbstring.c</a> and <a rel="nofollow" class="external text" href="http://www.linux-usb.org/gadget/usbstring.h">usbstring.h</a> files from the same site.  The driver has been modified as described in the Design section below.  The sources for this driver can be found in the sample code package in the USB_PCI_Device_App/src directory.
</p>
<h4><span class="mw-headline" id="Design_2">Design</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=13" title="Edit section: Design">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p>This driver has 2 main threads of execution which are used to accomplish the movement of data between the PCI and USB interfaces.  They are described below:
</p>
<h5><span class="mw-headline" id="simple_source_thread">simple_source_thread</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=14" title="Edit section: simple source thread">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p>This function is a modified version of the original function.  This function has been modified to open the PCI device and wait for an interrupt to be triggered indicating that there is data to be written from the PCI buffer over the USB connection.  The basic flow of operations is
</p>
<ol><li>Open the PCI device
<dl><dd>devDesc = open("/dev/dm6467pci". O_RDWR);</dd></dl></li>
<li>Loop until program signals threads to exit.
<ol><li>Wait for an interrupt over PCI
<dl><dd>waitForInterrupt(devDesc);</dd></dl></li>
<li>Write the contents of the PCI buffer over USB
<dl><dd>status = write (source_fd, buffer, USB_BUFSIZE);</dd></dl></li></ol></li>
<li>Close the PCI device
<dl><dd>status = close(devDesc);</dd></dl></li></ol>
<h5><span class="mw-headline" id="simple_sink_thread">simple_sink_thread</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=15" title="Edit section: simple sink thread">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p>This function is a modified version of the original function.  This function has been modified to open the PCI device and wait data to be written over the USB interface.  Once data has been received an interrupt to the PCI host will be triggered indicating that there is data to be read from the PCI buffer.  This function is also responsible for mmap'ing the PCI buffer used by both the sink and source threads.  The basic flow of operations is
</p>
<ol><li>Open the PCI device
<dl><dd>devDesc = open("/dev/dm6467pci". O_RDWR);</dd></dl></li>
<li>mmap the PCI buffer
<dl><dd>buffer = (char *)mmap(NULL, USB_BUFSIZE, (PROT_READ|PROT_WRITE)
<dl><dd><dl><dd><dl><dd>, MAP_SHARED, devDesc, (off_t)0x11818000);</dd></dl></dd></dl></dd></dl></dd>
<dd>NOTE - This function uses the address 0x11818000 for the PCI buffer which is L2 cache memory.  If you wish to use a different memory location you will need to change this address here as well as in the PCI host application.</dd></dl></li>
<li>Loop until program signals threads to exit.
<ol><li>Read data over USB into PCI buffer.  This blocks until data is sent
<dl><dd>status = read (sink_fd, buffer, USB_BUFSIZE);</dd></dl></li>
<li>Interrupt the PCI host to signal that data is available
<dl><dd>sendInterrupt(devDesc);</dd></dl></li></ol></li>
<li>munmap the PCI buffer
<dl><dd>munmap(buffer, USB_BUFSIZE);</dd></dl></li>
<li>Close the PCI device
<dl><dd>status = close(devDesc);</dd></dl></li></ol>
<h4><span class="mw-headline" id="Compilation_2">Compilation</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=16" title="Edit section: Compilation">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p>This driver must be compiled for the DM6467.  In the src directory there is a Makefile.  You will need to modify the Makefile in order to set the proper KERNDIR value.  The KERNDIR variable is the path to the include directory of your LSP tree.  In this example KERNDIR is /home/user/kernel/ti-davinci/include  If you are compiling on the DM6467 you can simply type <i>make</i> to compile the driver.  If you are compiling on a Linux host workstation you will need to specify the CROSS_COMPILE variable in order to use the proper compiler.  In most cases you will be cross compiling since you probably will not have your kernel sources installed on the target system.
</p><p>On the DM6467:
</p>
<pre> make
</pre>
<p>On the Linux host workstation
</p>
<pre> make CROSS_COMPILE=arm_v5t_le-
</pre>
<p>The build will create an executable called usb.  This is the user space USB driver and should be copied to the target file system.
</p>
<h4><span class="mw-headline" id="Usage_2">Usage</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=17" title="Edit section: Usage">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p>In order to use the usb driver you must setup the GadgetFS file system and driver as well as the PCI slave driver.  There is a script in the USB_PCI_Device_App/scripts directory named setup_USB_to_PCI.sh which will do this for you.  You should copy this script to your target file system at the same location where the user space USB driver compiled in the previous step was copied.  The script can then be executed to setup the file system and start the driver using the command
</p>
<pre>  ./setup_USB_to_PCI.sh
</pre>
<p>The steps the script takes are:
</p>
<ol><li>Create a mount point for the GadgetFS file system
<dl><dd>mkdir /dev/gadget</dd></dl></li>
<li>Load the PCI and GadgetFS drivers
<dl><dd>modprobe gadgetfs</dd>
<dd>modprobe pcimodule</dd></dl></li>
<li>Mount the GadgetFS file system
<dl><dd>mount -t gadgetfs gadgetfs /dev/gadget</dd></dl></li>
<li>Start the user space USB driver in verbose mode.
<dl><dd>./usb -v</dd></dl></li></ol>
<p>After the script has run you should see output on your console similar to:
</p>
<pre>root@158.218.49.73:~# ./setup_USB_to_PCI.sh
Creating mount point
Loading Drivers
gadgetfs: USB Gadget filesystem, version 24 Aug 2004
pcimodule: module license 'unspecified' taints kernel.
Mounting USB Gadget File System
Starting USB Gadget Driver
DEVNAME = musb_hdrc
gadgetfs: bound to musb_hdrc driver
/dev/gadget/musb_hdrc ep0 configured
serial="o2sse8g556z467tf41bt9n0ltyou48gaew0rwnvmc10h9blw3x86qqg1crkmjwf"
gadgetfs: suspended from state 2
SUSPEND
</pre>
<p>Once the DM6467 is connected via USB to a device running the usbtest module you should see output similar to:
</p>
<pre>gadgetfs: connected
CONNECT high speed
SETUP 80.06 v0300 i0000 255
SETUP 80.06 v0302 i0409 255
SETUP 80.06 v0301 i0409 255
SETUP 80.06 v0303 i0409 255
SETUP 80.06 v0303 i0409 255
SETUP 80.06 v0303 i0409 255
SETUP 80.06 v0303 i0409 2
SETUP 80.06 v0303 i0409 128
gadgetfs: configuration #3
SETUP 00.09 v0003 i0000 0
CONFIG #3
simple_source_thread start 1083468640 fd 5
simple_sink_thread start 1091857248 fd 7
</pre>
<p>The last two lines indicate that the source and sink threads are running and waiting for data.  You can exit this user space USB driver at any time by pressing <b>CTRL + C</b>.  You will see output similar to:
</p>
<pre>ep0 gadgetfs: disconnected
read after poll: Interrupted system call
done
</pre>
<h3><span class="mw-headline" id="PCI_Slave_Driver">PCI Slave Driver</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=18" title="Edit section: PCI Slave Driver">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>The PCI slave driver is included as part of the LSP kernel and can be used without modification.
</p>
<h4><span class="mw-headline" id="Design_3">Design</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=19" title="Edit section: Design">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p>For more information on the design of the PCI slave driver please see the <b>LSP 1.30 DM6467 PCI Slave Driver User's Guide</b> document in the docs/dm646x directory of the DVSDK PSP directory.
</p>
<h4><span class="mw-headline" id="Usage_3">Usage</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=20" title="Edit section: Usage">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p>This driver is loaded by using the <b>modprobe pcimodule</b> command.  It creates the device node /dev/dm6467pci which can be used to interract with the driver.
</p>
<h2><span class="mw-headline" id="PCI_Host_Setup">PCI Host Setup</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=21" title="Edit section: PCI Host Setup">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>This section will cover the steps required to use the PCI host driver and application for the data loopback as well as booting of the DM6467.
</p>
<h3><span class="mw-headline" id="PCI_Host_Driver">PCI Host Driver</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=22" title="Edit section: PCI Host Driver">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>This driver is based on the PCI host driver provided as part of the PSP package.  This driver is used to do the I/O operations over the PCI bus to/from the DM6467.  The original driver sources can be found in the PSP/board_utilities/dm646x/pci_boot.tar.gz package in the DVSDK.  The driver used in this demo has been modified as described in the design section below and can be found in the PCI_Host_App/src directory in the sample code package.
</p>
<h4><span class="mw-headline" id="Design_4">Design</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=23" title="Edit section: Design">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p>This driver required modification to allow a user space application to block while waiting for an interrupt.  This was done by using a simple ioctl operation that was added to the driver.  The new ioctl is named DM646X_PCI_WAIT_INTRPT and takes no arguments.  This ioctl performs a wait_for_completion operation and the interrupt service routine of the driver has been modified such that if there is a non-NULL wait structure then a completion is performed.  In this case the user space application that performs the data read/write operations can wait for data to become available from the DM6467.
</p><p>For more details on the rest of the driver functionality please see the <b>LSP 1.30 DM6467 PCI Boot Driver User's Guide</b> in the PSP/docs/dm646x directory of the DVSDK.
</p>
<h4><span class="mw-headline" id="Compilation_3">Compilation</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=24" title="Edit section: Compilation">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p>The Makefile in the src directory is setup to compile the driver for the running kernel as well as the Host application that will boot the board and allow the user to perform a PCI loopback.  To build the driver and host application on the PCI Host system just type <i>make</i> in the src directory.  This will create a driver module <b>dm646x_pci_boot.ko</b> and the user space application executable <b>pci_loopback_host_app.o</b>.
</p><p>NOTE: This driver has been validated on RedHat Enterprise Linux 4.  It may require some modification for other distributions.
</p>
<h4><span class="mw-headline" id="Usage_4">Usage</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=25" title="Edit section: Usage">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p>This driver requires no parameters and just needs to be loaded with the insmod command on the PCI host system.  This driver will need to be loaded each time the PCI host machine is rebooted.  NOTE:  You will need to execute the insmod command with root permissions.
</p>
<dl><dd>insmod ./dm646x_pci_boot.ko</dd></dl>
<p>You should see output like the following in the messages log when the driver is loaded.
</p>
<pre>dm646x_pci_boot: module license 'unspecified' taints kernel.
DM646x PCI Boot: Major number 254 assigned
PCIDRV - Added device to the sys file system
Found DM646x PCI device at 0xc1670c00
PCIDRV - Found PCI Devices
PCIDRV - BAR Configuration -
          Start        |       Length  |       Flags
       0xff8f8000      |       32768   |       0x00000200
       0xff8f0000      |       32768   |       0x00000200
       0xff400000      |       4194304 |       0x00000200
       0xf6ae0000      |       131072  |       0x00001208
ARM TCM RAM memory mapped to 0xe0b40000
DDR2 Memory Controller registers mapped to 0xe0b50000
MMR registers mapped to 0xe0b80000
Original BAR-4 value    = 0x80000000
New BAR-4 value =       0x82000000
Original BAR-5 value    = 0x80800000
New BAR-5 value =       0x82800000
       0xf6000000      |       8388608 |       0x00001208
       0xf5800000      |       8388608 |       0x00001208
DDR2 memory mapped to 0xe1000000
Communication/Script area mapped to 0xe1100000
Linux area mapped to 0xe1200000
DDR2-B memory mapped to 0xe1980000
ACPI: PCI Interrupt 0000:01:0c.0[A] -&gt; GSI 17 (level, low) -&gt; IRQ 185
PCIDRV - Device enabled
PCIDRV - Driver Data Set
PCIDRV - Set as the Bus-Master
Interrupt number is&#160;: 185
PCIDRV - Interrupts registered

UBL completed its job; BC is cleared; DDR2 is initialized
Original BAR-5 value    = 0x82800000
New BAR-5 value =       0x83000000
Original BAR-5 value    = 0x83000000
New BAR-5 value =       0x82800000
Original BAR-4 value    = 0x82000000
New BAR-4 value =       0x81000000
Original BAR-4 value    = 0x81000000
New BAR-4 value =       0x82000000
</pre>
<h3><span class="mw-headline" id="PCI_Host_Application">PCI Host Application</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=26" title="Edit section: PCI Host Application">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>The PCI host application is based on the saBootApp application from the PSP.  This application is responsible for booting the DM6467 device over the PCI bus and then performing the PCI loopback functionality.
</p>
<h4><span class="mw-headline" id="Design_5">Design</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=27" title="Edit section: Design">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p>The primary modification made to the saBootApp application was to add the <i>loopback</i> command to the console_control function.  This command will cause the application to go into an infinite loop in which the following steps are performed:
</p>
<ol><li>Begin Loop</li>
<li>Wait for an interrupt from the DM6467
<dl><dd>result = ioctl(dev_desc, DM646X_PCI_WAIT_INTRPT);</dd></dl></li>
<li>Read the data over PCI and then write it back over PCI
<dl><dd>result = loop_dma_once();</dd></dl></li>
<li>Send an interrupt to the DM6467 indicating data is available
<dl><dd>result = ioctl(dev_desc, DM646X_PCI_GEN_INTRPT);</dd></dl></li></ol>
<p>NOTE:  This application uses the address 0x11818000 which matches the address used by the user space USB driver on the DM6467.  If you wish to use another address you will need to modify the <i>location</i> variable in the loop_dma_once function to the new address.
</p>
<h4><span class="mw-headline" id="Usage_5">Usage</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=28" title="Edit section: Usage">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p>The steps to build this application were covered in the compilation section of the PCI host driver above.  To use this application the following steps need to be performed.
</p>
<ul><li>Create a working directory on the PCI host machine and copy the PCI_Host_App directory to it.  For this example the working directory will be /home/user/workdir
<dl><dd>mkdir /home/user/workdir</dd>
<dd>cp -rf &lt;sample code location&gt;/PCI_Host_App /home/user/workdir</dd>
<dd>cd /home/user/workdir/PCI_Host_App</dd></dl></li>
<li>Create a directory to place the executables in.
<dl><dd>mkdir bin</dd></dl></li>
<li>Copy the UBL to your working directory.  The UBL for PCI boot mode can be found in the PSP/bin/dm646x directory of the DVSDK and is called <b>ubl_dm646x_297_pci.bin</b>.  The UBL must be named <b>ublDaVinci.bin</b> and needs to be in the same directory as the PCI host application.
<dl><dd>cp &lt;PSP dir&gt;/bin/dm646x/ubl_dm646x_297_pci.bin bin/ublDaVinci.bin</dd></dl></li>
<li>Copy the U-Boot bootloader for PCI to the bin directory.   The U-Boot for PCI boot mode can be found in the PSP/bin/dm646x directory of the DVSDK and is called <b>u-boot_pci.bin</b>.
<dl><dd>cp &lt;PSP dir&gt;/bin/dm646x/u-boot_pci.bin ./bin/</dd></dl></li>
<li>Copy the target kernel image created in the <a href="#Kernel_Configuration_2">Kernel Configuration</a> section to the bin directory.  NOTE: If you are booting over tftp you still need the kernel image in the bin directory to be copied to the DM6467 over PCI, however it will not be used.  If you are not using tftp this is the kernel image that will be booted on the board.  User's may find it useful to use tftp during development and then switch to using the uImage over PCI when the kernel image is solidified.
<dl><dd>cp &lt;target kernel image&gt; ./bin/</dd></dl></li>
<li>Copy the target file system image to the bin directory.  NOTE: If you are booting using an NFS root file system you will still need to provide a file for the ramdisk, but it can be any file and does not have to be a valid ramdisk file system.  If you are not booting using NFS then you will need to provide a valid ramdisk file system.  User's may find it useful to use tftp during development and then copy their application files to a ramdisk to be used over PCI when the application is done with development.
<dl><dd>cp &lt;ramdisk&gt; ./bin/</dd></dl></li>
<li>Create a boot script image.  Examples can be found in the PCI_Host_App/scripts directory.  The bootnetwork.txt script is an example for booting the board over tftp using an NFS root file system.  the bootscript.txt is an example of how to boot the board over PCI in a stand alone mode without requiring networking.  For more information see the README.txt file in the scripts directory.  After creating the script file you must create a binary image of the script to be sent to the DM6467.  This can be done by using the following command:
<dl><dd>mkimage -T script -A arm -C none -n 'Boot Script File' -d &lt;script name&gt; &lt;output name&gt;</dd>
<dd>i.e. mkimage -T script -A arm -C none -n 'Boot Script File' -d bootnetwork.txt bootnetwork.img</dd></dl></li>
<li>Copy the boot script image to the bin directory.
<dl><dd>cp bootnetwork.img ./bin/</dd></dl></li>
<li>Copy the PCI host driver to the bin directory
<dl><dd>cp src/dm646x_pci_boot.ko ./bin/</dd></dl></li>
<li>Copy the PCI host boot application to the bin directory
<dl><dd>cp src/pci_loopback_host_app.o ./bin/</dd></dl></li>
<li>Copy the helper script <b>run_test.sh</b> from the PCI_Host_App directory to the bin directory.
<dl><dd>cp run_test.sh ./bin/</dd></dl></li>
<li>Edit the run_test.sh script and change the variables PCI_DRIVER, UBOOT, UIMAGE, RAMDISK, and BOOTIMG to reflect your setup.</li>
<li>Run the run_test.sh script.  This script will insmod the PCI host driver and start the PCI host application.  Once the application starts you should see output similar to:</li></ul>
<pre>Loading PCI Host driver
Executing Boot and Host Application
ublDaVinci.bin file opened
Size of ublDaVinci.bin file = 14336
14336 bytes read from file ublDaVinci.bin
networkboot.img file opened
Size of networkboot.img file = 496
496 bytes read from file networkboot.img
Bar-5 mapped to 0xb7785000
ramdisk.gz file opened
Size of ramdisk.gz file = 2393160
1048576 bytes read from file ramdisk.gz
Bar-5 remapped to 0x83000000
1344584 bytes read from file ramdisk.gz
Bar-5 remapped to 0x82800000
uImage file opened
Size of uImage file = 1379004
1379004 bytes read from file uImage
u-boot_pci.bin file opened
Size of u-boot_pci.bin file = 99100
99100 bytes read from file u-boot_pci.bin

Type "help" or "?" for available commands
PCIConsole:\&gt;
</pre>
<ul><li>At the <b>PCIConsole:&gt;</b> prompt type <b>loopback</b> and press ENTER.  This will start the PCI host application to begin waiting for data to loopback over the PCI bus.</li></ul>
<h2><span class="mw-headline" id="Putting_it_all_Together">Putting it all Together</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit&amp;section=29" title="Edit section: Putting it all Together">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>Now that you know how to build and run each of the three components of this sample application it is time to cover how to use them all together.  In order to get the timing information for a 512 byte packet to be transfered over USB, to PCI, back over PCI, and then back over USB the following steps need to be performed.
</p><p>Test Setup:
</p>
<ul><li>Kernel Image: uImage-pcigadgetfs</li>
<li>Root File System: NFS file system located at /home/user/filesys</li>
<li>Boot Method: PCI boot with kernel over tftp and NFS root file system</li>
<li>Connections:
<ul><li>USB cable connected between DM6467 and USB host</li>
<li>Network cable connected to DM6467</li>
<li>Serial cable connected to DM6467</li></ul></li></ul>
<p>Test Procedure:
</p>
<ol><li>Boot the USB host system.  In this example the host system is a DM6446 EVM running MontaVista Linux.</li>
<li>Boot the PCI host system.  In this example the PCI host system is a Linux workstation running RedHat Enterprise Linux 4.0 with the DM6467 plugged in to one of the PCI slots.</li>
<li>Open a serial terminal to view the boot messages of the DM6467 generated in the next step.</li>
<li>Boot the DM6467 using the PCI host application.  Refer to the Usage section of the PCI host application above for how to boot the DM6467 board.</li>
<li>When the DM6467 has finished booting login as <b>root</b></li>
<li>Start the user space USB driver as detailed in the usage section of the USB user space driver.</li>
<li>On the PCI host type <b>loopback</b> at the <b>PCIConsole:\&gt;</b> prompt</li>
<li>On the USB host run the USB_to_PCI_loop_test.o application as detailed in the usage section of the USB host test application section.</li>
<li>On the USB host you should see output similar to:</li></ol>
<pre>unknown speed   /proc/bus/usb/001/002
loop took    0.001188 sec


Maximum Loop Time =     0.001188 sec
Minimum Loop Time =     0.001188 sec
Average Loop Time =     0.001188 sec
Total Loop Time   =     0.001188 sec
</pre>
<p>You can rerun this test continously if you wish.  The average time observed is ~1ms to transfer 512 bytes of data over USB and PCI.
</p>
<!-- 
NewPP limit report
Cached time: 20201130210412
Cache expiry: 86400
Dynamic content: false
CPU time usage: 0.084 seconds
Real time usage: 0.092 seconds
Preprocessor visited node count: 126/1000000
Preprocessor generated node count: 148/1000000
Postexpand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip postexpand size: 842/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    0.000      1 -total
-->
</div>
<!-- Saved in parser cache with key procwiki:pcache:idhash:421-0!canonical and timestamp 20201130210412 and revision id 20169
 -->
<div class='hf-nsfooter' id='hf-nsfooter-'><table style="text-align:center; background:white; width:100%; text-align:left; height: 65px border-top: 1px solid; border-bottom: 1px solid; border-left: 1px solid; border-right: 1px solid; border-width: 1px; border-style: solid;">
<tr>
<td width="305px"><a href="File_E2e.html" class="image"><img alt="E2e.jpg" src="https://processors.wiki.ti.com/images/8/82/E2e.jpg" width="305" height="63" /></a>
</td>
<td>{{
<ol><li>switchcategory:MultiCore=</li></ol>
<ul><li>For technical support on MultiCore devices, please post your questions in the <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/dsp/c6000_multi-core_dsps/default.aspx">C6000 MultiCore Forum</a></li>
<li>For questions related to the BIOS MultiCore SDK (MCSDK), please use the <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/embedded/f/355.aspx">BIOS Forum</a></li></ul>
<p>Please post only comments related to the article <b>USB to PCI loopback</b> here.<i></i>
</p>
</td>
<td>Keystone=
<ul><li>For technical support on MultiCore devices, please post your questions in the <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/dsp/c6000_multi-core_dsps/default.aspx">C6000 MultiCore Forum</a></li>
<li>For questions related to the BIOS MultiCore SDK (MCSDK), please use the <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/embedded/f/355.aspx">BIOS Forum</a></li></ul>
<p>Please post only comments related to the article <b>USB to PCI loopback</b> here.<i></i>
</p>
</td>
<td>C2000=<i>For technical support on the C2000 please post your questions on <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/microcontrollers/tms320c2000_32-bit_real-time_mcus/f/171.aspx">The C2000 Forum</a>. Please post only comments about the article <b>USB to PCI loopback</b> here.</i>
</td>
<td>DaVinci=<i>For technical support on DaVincoplease post your questions on <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/dsp/davinci_digital_media_processors/default.aspx">The DaVinci Forum</a>. Please post only comments about the article <b>USB to PCI loopback</b> here.</i>
</td>
<td>MSP430=<i>For technical support on MSP430 please post your questions on <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/microcontrollers/msp43016-bit_ultra-low_power_mcus/default.aspx">The MSP430 Forum</a>. Please post only comments about the article <b>USB to PCI loopback</b> here.</i>
</td>
<td>OMAP35x=<i>For technical support on OMAP please post your questions on <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/dsp/omap_applications_processors/default.aspx">The OMAP Forum</a>. Please post only comments about the article <b>USB to PCI loopback</b> here.</i>
</td>
<td>OMAPL1=<i>For technical support on OMAP please post your questions on <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/dsp/omap_applications_processors/default.aspx">The OMAP Forum</a>. Please post only comments about the article <b>USB to PCI loopback</b> here.</i>
</td>
<td>MAVRK=<i>For technical support on MAVRK please post your questions on <a rel="nofollow" class="external text" href="http://e2e.ti.com/support/development_tools/mavrk/default.aspx">The MAVRK Toolbox Forum</a>. Please post only comments about the article <b>USB to PCI loopback</b> here.</i>
</td>
<td><i>For technical support please post your questions at <a rel="nofollow" class="external text" href="http://e2e.ti.com/">http://e2e.ti.com</a>. Please post only comments about the article <b>USB to PCI loopback</b> here.</i>
<p>}}
</p>
</td></tr></table>
<table style="border-style:solid; border-width:1px; text-align:center; width:100%;">

<tr style="font-size:150%;">
<td rowspan="2"><a href="File_Hyperlink_blue.html" class="image"><img alt="Hyperlink blue.png" src="https://processors.wiki.ti.com/images/9/9f/Hyperlink_blue.png" width="96" height="96" /></a>
</td>
<td><b>Links</b>
</td></tr>
<tr>
<td>
<table style="text-align: left;">
<tr>
<td style="padding-right: 10px; vertical-align: top;">
<p><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/amplifier_and_linear.page">Amplifiers &amp; Linear</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/audio/audio_overview.page">Audio</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/rfif.page">Broadband RF/IF &amp; Digital Radio</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/clocksandtimers/clocks_and_timers.page">Clocks &amp; Timers</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/dataconverters/data_converter.page">Data Converters</a>
</p>
</td>
<td style="padding-right: 10px; vertical-align: top;">
<p><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/mems/mems.page">DLP &amp; MEMS</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/high_reliability.page">High-Reliability</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/interface/interface.page">Interface</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/logic/home_overview.page">Logic</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/powermanagement/power_portal.page">Power Management</a>
</p>
</td>
<td style="padding-right: 10px; vertical-align: top;">
<p><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/dsp/embedded_processor.page">Processors</a>
</p>
<ul><li><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/dsp/arm.page">ARM Processors</a></li>
<li><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/dsp/home.page">Digital Signal Processors (DSP)</a></li>
<li><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/microcontroller/home.page">Microcontrollers (MCU)</a></li>
<li><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/omap-applications-processors/the-omap-experience.page">OMAP Applications Processors</a></li></ul>
</td>
<td style="padding-right: 10px; vertical-align: top;">
<p><a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/switches_and_multiplexers.page">Switches &amp; Multiplexers</a><br/>
<a rel="nofollow" class="external text" href="http://www.ti.com/lsds/ti/analog/temperature_sensor.page">Temperature Sensors &amp; Control ICs</a><br/>
<a rel="nofollow" class="external text" href="http://focus.ti.com/wireless/docs/wirelessoverview.tsp?familyId=2003&amp;sectionId=646&amp;tabId=2735">Wireless Connectivity</a>
</p>
</td></tr></table>
</td></tr></table>
<div id="tiPrivacy"></div>
</div></div>					<div class="printfooter">
						Retrieved from "<a dir="ltr" href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;oldid=20169">https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;oldid=20169</a>"					</div>
				<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="Special_Categories.html" title="Special:Categories">Categories</a>: <ul><li><a href="Category_Linux.html" title="Category:Linux">Linux</a></li><li><a href="Category_USB.html" title="Category:USB">USB</a></li><li><a href="Category_PCI.html" title="Category:PCI">PCI</a></li></ul></div></div>				<div class="visualClear"></div>
							</div>
		</div>
		<div id="mw-navigation">
			<h2>Navigation menu</h2>
			<div id="mw-head">
									<div id="p-personal" role="navigation" class="" aria-labelledby="p-personal-label">
						<h3 id="p-personal-label">Personal tools</h3>
						<ul>
							<li id="pt-login"><a href="https://processors.wiki.ti.com/index.php?title=Special:UserLogin&amp;returnto=USB+to+PCI+loopback" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li><li id="pt-createaccount"><a href="Special_RequestAccount.html" title="You are encouraged to create an account and log in; however, it is not mandatory">Request account</a></li>						</ul>
					</div>
									<div id="left-navigation">
										<div id="p-namespaces" role="navigation" class="vectorTabs" aria-labelledby="p-namespaces-label">
						<h3 id="p-namespaces-label">Namespaces</h3>
						<ul>
							<li id="ca-nstab-main" class="selected"><span><a href="USB_to_PCI_loopback.html" title="View the content page [c]" accesskey="c">Page</a></span></li><li id="ca-talk" class="new"><span><a href="https://processors.wiki.ti.com/index.php?title=Talk:USB_to_PCI_loopback&amp;action=edit&amp;redlink=1" rel="discussion" title="Discussion about the content page (page does not exist) [t]" accesskey="t">Discussion</a></span></li>						</ul>
					</div>
										<div id="p-variants" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-variants-label">
												<input type="checkbox" class="vectorMenuCheckbox" aria-labelledby="p-variants-label" />
						<h3 id="p-variants-label">
							<span>Variants</span>
						</h3>
						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
									</div>
				<div id="right-navigation">
										<div id="p-views" role="navigation" class="vectorTabs" aria-labelledby="p-views-label">
						<h3 id="p-views-label">Views</h3>
						<ul>
							<li id="ca-view" class="collapsible selected"><span><a href="USB_to_PCI_loopback.html">Read</a></span></li><li id="ca-viewsource" class="collapsible"><span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></span></li><li id="ca-history" class="collapsible"><span><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=history" title="Past revisions of this page [h]" accesskey="h">View history</a></span></li>						</ul>
					</div>
										<div id="p-cactions" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-cactions-label">
						<input type="checkbox" class="vectorMenuCheckbox" aria-labelledby="p-cactions-label" />
						<h3 id="p-cactions-label"><span>More</span></h3>
						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
										<div id="p-search" role="search">
						<h3>
							<label for="searchInput">Search</label>
						</h3>
						<form action="https://processors.wiki.ti.com/index.php" id="searchform">
							<div id="simpleSearch">
								<input type="search" name="search" placeholder="Search Texas Instruments Wiki" title="Search Texas Instruments Wiki [f]" accesskey="f" id="searchInput"/><input type="hidden" value="Special:Search" name="title"/><input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton mw-fallbackSearchButton"/><input type="submit" name="go" value="Go" title="Go to a page with this exact name if it exists" id="searchButton" class="searchButton"/>							</div>
						</form>
					</div>
									</div>
			</div>
			<div id="mw-panel">
				<div id="p-logo" role="banner"><a class="mw-wiki-logo" href="Main_Page.html"  title="Visit the main page"></a></div>
						<div class="portal" role="navigation" id="p-navigation" aria-labelledby="p-navigation-label">
			<h3 id="p-navigation-label">Navigation</h3>
			<div class="body">
								<ul>
					<li id="n-mainpage"><a href="Main_Page.html" title="Visit the main page [z]" accesskey="z">Main Page</a></li><li id="n-All-pages"><a href="Special_AllPages.html">All pages</a></li><li id="n-All-categories"><a href="Special_Categories.html">All categories</a></li><li id="n-recentchanges"><a href="Special_RecentChanges.html" title="A list of recent changes in the wiki [r]" accesskey="r">Recent changes</a></li><li id="n-randompage"><a href="Package_Reflow_Profiles.html" title="Load a random page [x]" accesskey="x">Random page</a></li><li id="n-help"><a href="https://www.mediawiki.org/wiki/Special:MyLanguage/Help:Contents" title="The place to find out">Help</a></li>				</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id="p-tb" aria-labelledby="p-tb-label">
			<h3 id="p-tb-label">Toolbox</h3>
			<div class="body">
								<ul>
					<li id="t-whatlinkshere"><a href="Special_WhatLinksHere/USB_to_PCI_loopback.html" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li><li id="t-recentchangeslinked"><a href="Special_RecentChangesLinked/USB_to_PCI_loopback.html" rel="nofollow" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li><li id="t-specialpages"><a href="Special_SpecialPages.html" title="A list of all special pages [q]" accesskey="q">Special pages</a></li><li id="t-print"><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li><li id="t-permalink"><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;oldid=20169" title="Permanent link to this revision of the page">Permanent link</a></li><li id="t-info"><a href="https://processors.wiki.ti.com/index.php?title=USB_to_PCI_loopback&amp;action=info" title="More information about this page">Page information</a></li>				</ul>
							</div>
		</div>
				</div>
		</div>
				<div id="footer" role="contentinfo">
						<ul id="footer-info">
								<li id="footer-info-lastmod"> This page was last edited on 24 November 2009, at 12:16.</li>
								<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike</a> unless otherwise noted.</li>
							</ul>
						<ul id="footer-places">
								<li id="footer-places-privacy"><a href="Project_Privacy_policy.html" title="Project:Privacy policy">Privacy policy</a></li>
								<li id="footer-places-about"><a href="Project_About.html" title="Project:About">About Texas Instruments Wiki</a></li>
								<li id="footer-places-disclaimer"><a href="Project_General_disclaimer.html" title="Project:General disclaimer">Disclaimers</a></li>
								<li id="footer-places-termsofservice"><a href="Project_Terms_of_Service.html" title="Project:Terms of Service">Terms of Use</a></li>
							</ul>
										<ul id="footer-icons" class="noprint">
										<li id="footer-copyrightico">
						<a href="http://creativecommons.org/licenses/by-sa/3.0/"><img src="https://processors.wiki.ti.com/resources/assets/licenses/cc-by-sa.png" alt="Creative Commons Attribution-ShareAlike" width="88" height="31"/></a>					</li>
										<li id="footer-poweredbyico">
						<a href="http://www.mediawiki.org/"><img src="https://processors.wiki.ti.com/resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31"/></a>					</li>
									</ul>
						<div style="clear: both;"></div>
		</div>
		<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgPageParseReport":{"limitreport":{"cputime":"0.084","walltime":"0.092","ppvisitednodes":{"value":126,"limit":1000000},"ppgeneratednodes":{"value":148,"limit":1000000},"postexpandincludesize":{"value":0,"limit":2097152},"templateargumentsize":{"value":0,"limit":2097152},"expansiondepth":{"value":2,"limit":40},"expensivefunctioncount":{"value":0,"limit":100},"unstrip-depth":{"value":0,"limit":20},"unstrip-size":{"value":842,"limit":5000000},"timingprofile":["100.00%    0.000      1 -total"]},"cachereport":{"timestamp":"20201130210412","ttl":86400,"transientcontent":false}}});});</script><script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgBackendResponseTime":234});});</script>
	</body>

<!-- Mirrored from processors.wiki.ti.com/index.php/USB_to_PCI_loopback by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 01 Dec 2020 08:18:59 GMT -->
</html>
